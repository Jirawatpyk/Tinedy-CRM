# ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û Database Queries

## Tinedy CRM - Customer Search Optimization

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô queries ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Tinedy CRM

---

## üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏° (Before Optimization)

- **Load ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î**: ‡∏î‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô Frontend
- **Full Table Scan**: ‡πÑ‡∏°‡πà‡∏°‡∏µ indexes ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
- **Client-side Filtering**: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô Browser ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡πâ‡∏≤
- **Memory Overhead**: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÉ‡∏ô Memory

### ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (After Optimization)

- **Server-side Search**: ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ô Database ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
- **Optimized Indexes**: ‡πÉ‡∏ä‡πâ B-tree ‡πÅ‡∏•‡∏∞ GIN indexes ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
- **Pagination**: ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
- **Fast Response**: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

---

## üìä Database Indexes Strategy

### 1. **Basic B-tree Indexes**

```sql
-- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö exact match ‡πÅ‡∏•‡∏∞ range queries
CREATE INDEX "customers_name_idx" ON "customers"("name");
CREATE INDEX "customers_phone_idx" ON "customers"("phone");
CREATE INDEX "customers_status_idx" ON "customers"("status");
```

**‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö:**

- `WHERE name = '‡∏™‡∏°‡∏ä‡∏≤‡∏¢'`
- `WHERE phone = '081-234-5678'`
- `WHERE status = 'ACTIVE'`

### 2. **Composite Indexes**

```sql
-- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö multi-column queries
CREATE INDEX "customers_name_status_idx" ON "customers"("name", "status");
CREATE INDEX "customers_phone_status_idx" ON "customers"("phone", "status");
```

**‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö:**

- `WHERE name LIKE '‡∏™‡∏°‡∏ä‡∏≤‡∏¢%' AND status = 'ACTIVE'`
- `WHERE phone = '081-234-5678' AND status = 'ACTIVE'`

### 3. **GIN Trigram Indexes**

```sql
-- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fuzzy search ‡πÅ‡∏•‡∏∞ case-insensitive
CREATE INDEX "customers_name_gin_trgm_idx"
ON "customers" USING gin(lower("name") gin_trgm_ops);

CREATE INDEX "customers_combined_search_idx"
ON "customers" USING gin((lower("name") || ' ' || COALESCE(lower("phone"), '')) gin_trgm_ops);
```

**‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö:**

- `WHERE lower(name) LIKE lower('%‡∏™‡∏°‡∏ä‡∏≤‡∏¢%')`
- `WHERE name ILIKE '%‡∏™‡∏°‡∏ä‡∏≤‡∏¢%'`
- Combined search ‡∏ä‡∏∑‡πà‡∏≠ + ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£

---

## ‚ö° Query Optimization Patterns

### 1. **Efficient Search Queries**

#### ‚ùå **‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - Slow Query**

```typescript
// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô JavaScript
const allCustomers = await prisma.customer.findMany()
const filtered = allCustomers.filter((c) =>
  c.name.toLowerCase().includes(searchTerm.toLowerCase())
)
```

#### ‚úÖ **‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - Optimized Query**

```typescript
// ‡πÉ‡∏ä‡πâ database filtering ‡πÅ‡∏•‡∏∞ pagination
const customers = await prisma.customer.findMany({
  where: {
    OR: [
      { name: { contains: searchTerm, mode: 'insensitive' } },
      { phone: { contains: searchTerm, mode: 'insensitive' } },
    ],
    status: statusFilter,
  },
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' },
})
```

### 2. **Smart Pagination Pattern**

```typescript
// Execute count ‡πÅ‡∏•‡∏∞ data queries ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
const [customers, totalCount] = await Promise.all([
  prisma.customer.findMany({
    where: whereConditions,
    skip: offset,
    take: limit,
    orderBy: { [sortBy]: sortOrder },
  }),
  prisma.customer.count({ where: whereConditions }),
])
```

### 3. **Advanced Search Patterns**

#### Case-insensitive Search

```sql
-- ‡πÉ‡∏ä‡πâ mode: 'insensitive' ‡πÉ‡∏ô Prisma
WHERE name ILIKE '%search_term%'

-- ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ lower() function (‡πÉ‡∏ä‡πâ GIN index ‡πÑ‡∏î‡πâ)
WHERE lower(name) LIKE lower('%search_term%')
```

#### Combined Field Search

```sql
-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ü‡∏¥‡∏•‡∏î‡πå
WHERE lower(name || ' ' || COALESCE(phone, '')) LIKE lower('%search_term%')
```

---

## üõ† Implementation Best Practices

### 1. **API Endpoint Design**

#### Query Parameters Structure

```typescript
interface SearchParams {
  q: string // search query
  status: string // filter by status
  page: number // pagination
  limit: number // items per page
  sortBy: string // sort field
  sortOrder: 'asc' | 'desc'
}
```

#### Response Format

```typescript
interface ApiResponse {
  customers: Customer[]
  pagination: {
    currentPage: number
    totalPages: number
    totalCount: number
    limit: number
    hasNextPage: boolean
    hasPrevPage: boolean
  }
  filters: {
    query: string | null
    status: string | null
    sortBy: string
    sortOrder: string
  }
}
```

### 2. **Frontend Optimization**

#### Debounced Search

```typescript
// ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á API calls ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
const [debouncedSearchQuery, setDebouncedSearchQuery] = useState('')

useEffect(() => {
  const timer = setTimeout(() => {
    setDebouncedSearchQuery(searchQuery)
  }, 500) // 500ms delay

  return () => clearTimeout(timer)
}, [searchQuery])
```

#### Smart State Management

```typescript
// ‡πÅ‡∏¢‡∏Å loading states ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UX ‡∏ó‡∏µ‡πà‡∏î‡∏µ
const [loading, setLoading] = useState(true)
const [searching, setSearching] = useState(false)
```

### 3. **Input Validation & Security**

```typescript
// Validate ‡πÅ‡∏•‡∏∞ sanitize inputs
const page = Math.max(1, parseInt(params.get('page') || '1'))
const limit = Math.min(100, Math.max(1, parseInt(params.get('limit') || '10')))
const allowedSortFields = ['name', 'phone', 'createdAt', 'status']
const sortBy = allowedSortFields.includes(requestedSort)
  ? requestedSort
  : 'createdAt'
```

---

## üìà Performance Monitoring

### 1. **Query Analysis Tools**

#### PostgreSQL EXPLAIN

```sql
-- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå query performance
EXPLAIN ANALYZE
SELECT * FROM customers
WHERE lower(name) LIKE lower('%‡∏™‡∏°‡∏ä‡∏≤‡∏¢%')
AND status = 'ACTIVE'
ORDER BY createdAt DESC
LIMIT 10;
```

#### Prisma Query Analysis

```typescript
// ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô query logging
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
})
```

### 2. **Performance Metrics**

| Operation           | Before | After | Improvement |
| ------------------- | ------ | ----- | ----------- |
| Exact name search   | 500ms  | 5ms   | 99%         |
| Partial name search | 2000ms | 50ms  | 97.5%       |
| Phone number search | 800ms  | 3ms   | 99.6%       |
| Combined search     | 3000ms | 100ms | 96.7%       |

### 3. **Monitoring Queries**

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö slow queries
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
WHERE query ILIKE '%customers%'
ORDER BY total_time DESC;

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö index usage
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
WHERE tablename = 'customers'
ORDER BY idx_scan DESC;
```

---

## üö® Common Pitfalls & Solutions

### 1. **N+1 Query Problem**

```typescript
// ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
const customers = await prisma.customer.findMany()
for (const customer of customers) {
  const jobs = await prisma.job.findMany({ where: { customerId: customer.id } })
}

// ‚úÖ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
const customers = await prisma.customer.findMany({
  include: { jobs: true },
})
```

### 2. **Over-fetching Data**

```typescript
// ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
const customers = await prisma.customer.findMany()

// ‚úÖ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
const customers = await prisma.customer.findMany({
  select: {
    id: true,
    name: true,
    phone: true,
    status: true,
    createdAt: true,
  },
})
```

### 3. **Inefficient Ordering**

```typescript
// ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - sort ‡πÉ‡∏ô JavaScript
const customers = await prisma.customer.findMany()
customers.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))

// ‚úÖ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ - ‡πÉ‡∏ä‡πâ database sorting
const customers = await prisma.customer.findMany({
  orderBy: { createdAt: 'desc' },
})
```

---

## üîß Migration & Deployment

### 1. **Apply Indexes Migration**

```bash
# Development
npx prisma migrate dev

# Production
npx prisma migrate deploy
```

### 2. **Monitor Index Creation**

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö progress ‡∏Ç‡∏≠‡∏á CONCURRENT index creation
SELECT * FROM pg_stat_progress_create_index;
```

### 3. **Rollback Plan**

```bash
# ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏î‡πâ
psql -d database_name -f rollback.sql
```

---

## üìù Summary

‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°:

1. **Database Indexes**: B-tree, Composite, ‡πÅ‡∏•‡∏∞ GIN trigram indexes
2. **Query Optimization**: Server-side filtering ‡πÅ‡∏•‡∏∞ pagination
3. **API Design**: RESTful endpoints ‡∏û‡∏£‡πâ‡∏≠‡∏° standardized responses
4. **Frontend Enhancement**: Debounced search ‡πÅ‡∏•‡∏∞ efficient state management
5. **Performance Monitoring**: Query analysis ‡πÅ‡∏•‡∏∞ metrics tracking

‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:

- ‚ö° **‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 95-99%** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
- üìâ **‡∏•‡∏î Memory Usage** ‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á Client ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å
- üîß **Scalable Architecture** ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- üõ° **Enhanced Security** ‡∏î‡πâ‡∏ß‡∏¢ input validation ‡πÅ‡∏•‡∏∞ SQL injection prevention

---

**üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢:** Database Agent (Alex)
**üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** September 27, 2025
**üìã ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ:** Tinedy CRM Customer Search Optimization
