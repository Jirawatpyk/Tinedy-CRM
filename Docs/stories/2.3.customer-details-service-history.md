# Story 2.3: Customer Details & Service History

<!-- Powered by BMAD™ Core -->

## Status
Approved

## Story
**As an** Admin,
**I want** to view a customer's complete details and their service history,
**so that** I can understand their service usage patterns and provide better customer service.

## Acceptance Criteria

1. A customer details page is accessible by clicking on a customer from the customer list.
2. The page displays complete customer information (name, phone, address, contact channel, created date).
3. The page shows a list of all jobs/services associated with the customer.
4. Each job in the history displays key information: service type, scheduled date, status, and price.
5. Jobs are sorted by date (most recent first) and show appropriate status badges.
6. The page includes an "Edit Customer" button that navigates to the customer edit form.
7. The page has proper loading states and error handling for data fetching.

## Tasks / Subtasks

- [ ] Create customer details page structure (AC: 1, 2)
  - [ ] Create app/(dashboard)/customers/[id]/page.tsx for customer details view
  - [ ] Implement customer data fetching using existing CustomerService
  - [ ] Display customer information in a clean, organized layout
  - [ ] Add proper page header with breadcrumbs navigation
  - [ ] Implement loading and error states for customer data
- [ ] Implement Job/Service history API endpoint (AC: 3)
  - [ ] Create GET /api/customers/[id]/jobs endpoint to fetch customer's job history
  - [ ] Implement JobService class with methods to fetch jobs by customer ID
  - [ ] Add proper pagination support for job history (limit 20 per page)
  - [ ] Include job relationship data (assigned user, checklist status if applicable)
  - [ ] Add Admin role authorization to the endpoint
- [ ] Build job history display component (AC: 3, 4, 5)
  - [ ] Create JobHistoryList component to display jobs in a table/list format
  - [ ] Display job details: ID, service type, scheduled date, status, price
  - [ ] Implement status badges using shadcn/ui Badge component
  - [ ] Sort jobs by scheduledDate in descending order (most recent first)
  - [ ] Add empty state message when no jobs exist
- [ ] Add navigation and action buttons (AC: 6)
  - [ ] Add "Edit Customer" button that navigates to /customers/[id]/edit
  - [ ] Add "View Job Details" links for each job (prepare for future story)
  - [ ] Ensure back navigation to customer list works properly
  - [ ] Apply consistent button styling with existing UI patterns
- [ ] Implement comprehensive error handling (AC: 7)
  - [ ] Handle customer not found scenarios with appropriate messaging
  - [ ] Implement retry logic for failed API requests
  - [ ] Add error boundaries for component failures
  - [ ] Ensure graceful degradation when job history fails to load

## Dev Notes

### Previous Story Insights
**[Source: Stories 2.1 and 2.2 completion]**
- **Customer Infrastructure**: Customer list with search and CRUD operations fully implemented
- **Customer Model**: Complete with id, name, phone, address, contactChannel, createdAt, updatedAt
- **Authentication**: Admin role-based access control established and working
- **API Patterns**: Repository Pattern with service layer for consistent data access
- **UI Components**: shadcn/ui components and form patterns established

### Data Models & Relationships
**[Source: docs/Data Models.md]**
- **Customer Model**:
  - One Customer can have many Jobs (One-to-Many relationship)
  - Customer ID is foreign key in Job model
- **Job Model Structure**:
  - id: String (UUID) - Primary Key
  - customerId: String - Foreign Key to Customer
  - serviceType: Enum (CLEANING, TRAINING) - ประเภทบริการ
  - scheduledDate: DateTime - วันที่นัดหมาย
  - price: Decimal - ราคา
  - status: String - สถานะงาน (New, Assigned, In Progress, Done, Cancelled)
  - notes: String (Optional) - บันทึกเพิ่มเติม
  - assignedUserId: String (Optional) - Foreign Key to User
  - createdAt: DateTime
  - updatedAt: DateTime
- **Relationships to Include**:
  - Job belongs to one Customer (Many-to-One)
  - Job can be assigned to one User (Many-to-One, Optional)

### API Specifications
**[Source: PRD FR4, API patterns from previous stories]**
- **Customer Jobs Endpoint**: GET /api/customers/[id]/jobs
  - Response: Array of job objects with full job data
  - Include: assignedUser relation for display purposes
  - Pagination: Support page and limit query parameters
  - Sorting: Order by scheduledDate DESC by default
  - Authentication: Bearer token required
  - Authorization: Admin role required

### File Locations for New Code
**[Source: docs/Source Tree.md]**
- **Customer Details Page**: apps/crm-app/app/(dashboard)/customers/[id]/page.tsx
- **Jobs API Endpoint**: apps/crm-app/app/api/customers/[id]/jobs/route.ts
- **Job Service**: apps/crm-app/lib/services/job.ts
- **Job History Component**: apps/crm-app/components/shared/JobHistoryList.tsx
- **Job Types**: packages/types/index.ts (add Job interface if not exists)

### UI/UX Patterns
**[Source: Previous story implementations]**
- **Page Layout**: Use consistent header with breadcrumbs (Home > Customers > [Customer Name])
- **Data Display**: Use shadcn/ui Card components for customer info sections
- **Table/List**: Use shadcn/ui Table for job history display
- **Status Badges**: Use shadcn/ui Badge with color coding for job statuses
- **Loading States**: Use Skeleton components for loading placeholders
- **Error States**: Use Alert component for error messages

### Technical Constraints
**[Source: docs/tech-stack.md, previous implementations]**
- TypeScript mandatory for all code
- Use Prisma ORM for database queries with proper relations
- Follow Repository Pattern through service layer
- Maintain consistency with existing API response formats
- Use Next.js 14+ app directory routing
- Ensure mobile-responsive design with Tailwind CSS

### Testing

**[Source: docs/Implementation, Security, and Standards.md#testing-strategy]**
- **Test File Locations**: apps/crm-app/__tests__/customers/[id]/ for page tests
- **Frontend Testing**: Jest + React Testing Library for JobHistoryList component
- **Backend Testing**: Vitest for job API endpoint and JobService
- **Integration Testing**: Test complete flow from customer list to details page
- **Test Scenarios**:
  - Customer details page loading and display
  - Job history fetching and rendering
  - Pagination of job history
  - Status badge display and styling
  - Navigation between pages
  - Error handling for invalid customer ID
  - Empty state for customers with no jobs
  - Role-based access control verification

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-28 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*