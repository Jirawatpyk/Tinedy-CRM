# Story 4.1: N8N Webhook Integration for Auto Job Creation

<!-- Powered by BMAD™ Core -->

## Status
Draft - Under Review

**Scrum Master Review (2025-09-30)**: Effort adjusted from 5 to 7-8 days based on complexity analysis

## Story
**As a** System,
**I want** to have a secure webhook endpoint that N8N can call,
**so that** new bookings from LINE OA can be automatically created as jobs in the CRM without manual data entry, reducing operational overhead by 70% and eliminating data entry errors.

## Acceptance Criteria

**Based on PRD FR5: Webhook endpoint สำหรับ N8N integration:**

1. Secure webhook endpoint created at `/api/webhook/n8n/new-job` with API Key authentication
2. Validates incoming JSON payload structure using Zod schema before processing
3. Creates new customer automatically if not exists (match by phone number first, then email)
4. Creates new job with status "NEW" linked to the customer
5. Returns HTTP 202 Accepted on success with created job ID and customer ID
6. Returns appropriate error codes with descriptive messages:
   - 400 Bad Request: Invalid payload structure or missing required fields
   - 401 Unauthorized: Invalid or missing API Key
   - 500 Internal Server Error: Database or system errors
7. Logs all webhook requests with full payload for audit trail and debugging
8. Handles duplicate requests gracefully using idempotency key
9. Transaction-based creation (customer + job created atomically)
10. Validates all required fields: customer name, phone, service type, scheduled date, price
11. **Response time P95 < 500ms** (Performance requirement per PRD NFR5)
12. **Rate limiting enforced**: 100 requests per minute per API Key to prevent abuse

## Tasks / Subtasks

**Implementation tasks for N8N webhook integration:**

- [ ] Create webhook API endpoint (AC: 1, 2, 5, 6)
  - [ ] Create POST /api/webhook/n8n/new-job route in apps/crm-app/app/api/webhook/n8n/new-job/route.ts
  - [ ] Implement API Key authentication middleware checking X-API-Key header
  - [ ] Create Zod schema for webhook payload validation
  - [ ] Add error handling for 400, 401, 500 status codes
  - [ ] Return proper JSON responses with job ID and customer ID
  - [ ] Add rate limiting (100 requests per minute per API key)
  - [ ] Add request timeout (10 seconds max)
  - [ ] Add unit tests for API endpoint

- [ ] Implement customer auto-creation logic (AC: 3)
  - [ ] Create findOrCreateCustomer method in CustomerService
  - [ ] Check for existing customer by phone number (primary)
  - [ ] Check for existing customer by email (secondary)
  - [ ] Create new customer if not found with data from webhook
  - [ ] Set customer status to ACTIVE by default
  - [ ] Handle duplicate phone/email edge cases
  - [ ] Add validation for customer data (phone format, email format)
  - [ ] Add service layer tests

- [ ] Implement job auto-creation logic (AC: 4, 9)
  - [ ] Create createJobFromWebhook method in JobService
  - [ ] Link job to customer using customerId
  - [ ] Set job status to NEW automatically
  - [ ] Map webhook service type to ServiceType enum
  - [ ] Parse and validate scheduled date
  - [ ] Set price from webhook payload
  - [ ] Use Prisma transaction for atomic customer + job creation
  - [ ] Add rollback mechanism if either creation fails
  - [ ] Add service layer tests

- [ ] Add comprehensive logging and audit trail (AC: 7)
  - [ ] Create WebhookLog model in Prisma schema
  - [ ] Log all incoming requests with timestamp, payload, API key used
  - [ ] Log success/failure status with error messages
  - [ ] Log response time and status code
  - [ ] Store full request payload for debugging
  - [ ] Implement log retention policy (keep 90 days)
  - [ ] Add index on timestamp and status for query performance

- [ ] Implement idempotency mechanism (AC: 8)
  - [ ] Accept idempotency-key in request header
  - [ ] Check for existing webhook log with same idempotency key
  - [ ] Return existing job if idempotency key found (within 24 hours)
  - [ ] Prevent duplicate job creation from retried requests
  - [ ] Clean up old idempotency keys (> 24 hours)
  - [ ] Add tests for duplicate request handling

- [ ] Add comprehensive testing (All ACs)
  - [ ] API tests: Successful job creation with new customer
  - [ ] API tests: Successful job creation with existing customer
  - [ ] API tests: Invalid API key returns 401
  - [ ] API tests: Missing required fields returns 400
  - [ ] API tests: Malformed JSON returns 400
  - [ ] API tests: Duplicate idempotency key returns same job
  - [ ] API tests: Database error returns 500 with rollback
  - [ ] Integration tests: Full flow from webhook to job creation
  - [ ] E2E test: Mock N8N webhook call with Playwright
  - [ ] Load test: 100 concurrent requests succeed

## Dev Notes

### Previous Story Insights
**[Source: Epic 2 Stories 2.1-2.3 implementations]**
- ✅ **Customer Service**: CustomerService with CRUD methods ready
- ✅ **Job Service**: JobService with job creation methods available
- ✅ **Database Models**: Customer and Job models fully implemented
- ✅ **API Patterns**: Established error handling and response formats
- ✅ **Prisma Transactions**: Transaction patterns used in other APIs

### Data Models & Relationships
**[Source: docs/Data Models.md, prisma/schema.prisma]**

**Webhook Log Model (New):**
```prisma
model WebhookLog {
  id            String   @id @default(cuid())
  endpoint      String   // "/api/webhook/n8n/new-job"
  method        String   // "POST"
  statusCode    Int      // 200, 400, 401, 500
  payload       Json     // Full request payload
  response      Json?    // Response sent back
  apiKeyUsed    String   // Masked API key (last 4 digits)
  idempotencyKey String? @unique // For duplicate detection
  responseTime  Int      // Response time in milliseconds
  errorMessage  String?  // Error details if failed
  createdAt     DateTime @default(now())

  // Relations
  jobId         String?
  job           Job?     @relation(fields: [jobId], references: [id])
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])

  @@index([createdAt])
  @@index([statusCode])
  @@index([idempotencyKey])
}
```

**Customer Model (Existing):**
- Will be used with findOrCreateCustomer logic
- Match by: phone (primary), email (secondary)

**Job Model (Existing):**
- Will be created with status = "NEW"
- All fields populated from webhook payload

### N8N Webhook Payload Structure
**[Source: PRD FR5, N8N team specification]**

**Expected JSON Payload:**
```json
{
  "idempotencyKey": "LINE-12345-20250930-143022",
  "customer": {
    "name": "สมชาย ใจดี",
    "phone": "0812345678",
    "email": "somchai@example.com",
    "address": "123 ถนนสุขุมวิท กรุงเทพฯ 10110",
    "contactChannel": "LINE"
  },
  "job": {
    "serviceType": "CLEANING",
    "scheduledDate": "2025-10-05T09:00:00Z",
    "price": 1500.00,
    "notes": "ทำความสะอาดคอนโด 2 ห้องนอน",
    "description": "ห้องนอน 2 ห้อง, ห้องน้ำ 2 ห้อง, ห้องนั่งเล่น"
  },
  "metadata": {
    "source": "LINE_OA",
    "conversationId": "U1234567890abcdef",
    "timestamp": "2025-09-30T14:30:22Z"
  }
}
```

**Payload Validation Schema:**
```typescript
import { z } from 'zod';

const WebhookPayloadSchema = z.object({
  idempotencyKey: z.string().min(1),
  customer: z.object({
    name: z.string().min(1),
    phone: z.string().regex(/^0\d{9}$/, 'Invalid Thai phone number'),
    email: z.string().email().optional(),
    address: z.string().optional(),
    contactChannel: z.enum(['LINE', 'PHONE', 'EMAIL', 'WALK_IN']).default('LINE')
  }),
  job: z.object({
    serviceType: z.enum(['CLEANING', 'TRAINING']),
    scheduledDate: z.string().datetime(),
    price: z.number().positive(),
    notes: z.string().optional(),
    description: z.string().optional()
  }),
  metadata: z.object({
    source: z.string(),
    conversationId: z.string().optional(),
    timestamp: z.string().datetime()
  }).optional()
});
```

### API Specifications
**[Source: PRD FR5, REST API best practices]**

**POST /api/webhook/n8n/new-job**

**Request Headers:**
```
Content-Type: application/json
X-API-Key: <webhook_api_key>
X-Idempotency-Key: <unique_request_id> (optional, falls back to payload idempotencyKey)
```

**Success Response (202 Accepted):**
```json
{
  "success": true,
  "message": "Job created successfully",
  "data": {
    "jobId": "clxxx123456789",
    "customerId": "clyyy987654321",
    "jobStatus": "NEW",
    "customerCreated": false,
    "processedAt": "2025-09-30T14:30:25Z"
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "success": false,
  "error": "Validation failed",
  "details": {
    "customer.phone": "Invalid Thai phone number format",
    "job.serviceType": "Must be CLEANING or TRAINING"
  }
}
```

**Error Response (401 Unauthorized):**
```json
{
  "success": false,
  "error": "Invalid or missing API Key"
}
```

**Error Response (500 Internal Server Error):**
```json
{
  "success": false,
  "error": "Failed to create job",
  "message": "Database transaction failed",
  "requestId": "req_xxx123"
}
```

### Security Implementation
**[Source: PRD NFR4: Webhook Endpoint Security]**

**API Key Management:**
```typescript
// Environment variable
WEBHOOK_N8N_API_KEY=tinedy_webhook_prod_xxxxxxxxxxxxx

// Validation logic
const apiKey = request.headers.get('X-API-Key');
const expectedKey = process.env.WEBHOOK_N8N_API_KEY;

if (!apiKey || apiKey !== expectedKey) {
  return NextResponse.json(
    { success: false, error: 'Invalid or missing API Key' },
    { status: 401 }
  );
}
```

**Rate Limiting:**
```typescript
// Use upstash/ratelimit or similar
import { Ratelimit } from '@upstash/ratelimit';

const ratelimit = new Ratelimit({
  redis: redis,
  limiter: Ratelimit.slidingWindow(100, '1 m'), // 100 requests per minute
});

const { success } = await ratelimit.limit(apiKey);
if (!success) {
  return NextResponse.json(
    { success: false, error: 'Rate limit exceeded' },
    { status: 429 }
  );
}
```

**Request Timeout:**
```typescript
// Add timeout to prevent long-running requests
export const maxDuration = 10; // 10 seconds max for Vercel Functions
```

### File Locations for New Code
**[Source: docs/architecture/source-tree.md]**

**Backend (Create 4 files):**
- `apps/crm-app/app/api/webhook/n8n/new-job/route.ts` (CREATE - main webhook endpoint)
- `apps/crm-app/lib/services/webhook.ts` (CREATE - webhook business logic)
- `apps/crm-app/lib/validation/webhook-schema.ts` (CREATE - Zod schemas)
- `apps/crm-app/lib/utils/idempotency.ts` (CREATE - idempotency helpers)

**Extend Existing:**
- `apps/crm-app/lib/services/customer.ts` (EXTEND - add findOrCreateCustomer)
- `apps/crm-app/lib/services/job.ts` (EXTEND - add createJobFromWebhook)

**Database:**
- `apps/crm-app/prisma/schema.prisma` (EXTEND - add WebhookLog model)
- `apps/crm-app/prisma/migrations/xxx_add_webhook_log/migration.sql` (CREATE)

**Testing (Create 3 files):**
- `apps/crm-app/__tests__/api/webhook/n8n/route.test.ts` (CREATE)
- `apps/crm-app/__tests__/services/webhook.test.ts` (CREATE)
- `apps/crm-app/tests/e2e/webhook-integration.spec.ts` (CREATE)

### Integration Points
**[Source: Epic 2 implementations, N8N documentation]**
- **Existing Customer Service**: Will be extended with findOrCreateCustomer
- **Existing Job Service**: Will be extended with createJobFromWebhook
- **N8N Workflows**: External system calling this webhook
- **LINE OA**: Original source of booking data (via N8N)

### Testing Strategy
**[Source: docs/architecture/tech-stack.md]**

**Unit Tests (Backend):**
- Webhook payload validation with valid/invalid data
- Customer findOrCreate logic with existing/new customers
- Job creation from webhook payload
- API Key authentication checks
- Idempotency key handling
- Error response formatting

**Integration Tests:**
- Full flow: webhook → customer creation → job creation
- Transaction rollback on errors
- WebhookLog creation on success/failure
- Duplicate request handling

**E2E Tests:**
- Mock N8N webhook call with Playwright
- Verify job appears in dashboard after webhook
- Test with various service types and customer data
- Test error scenarios (invalid payload, missing API key)

**Load Tests:**
- 100 concurrent webhook requests
- Verify response time < 500ms
- Check database connection pool handling
- Monitor memory usage and cleanup

### Performance Considerations
**[Source: PRD NFR5: Performance requirements]**

**Target Metrics:**
- Response time: < 500ms (P95)
- Throughput: 100 requests/minute
- Success rate: > 99%
- Database transaction time: < 200ms

**Optimizations:**
- Use Prisma transactions for atomic operations
- Index WebhookLog table by timestamp and status
- Cache API key validation (if multiple keys in future)
- Async logging (don't block response on log writes)

### Error Scenarios and Handling
**[Source: Production-ready practices]**

**Scenario 1: Duplicate Phone Number**
- Check existing customer by phone
- Return existing customer
- Create new job linked to existing customer
- Log: "Customer exists, created job only"

**Scenario 2: Invalid Service Type**
- Validate against enum ['CLEANING', 'TRAINING']
- Return 400 with specific error
- Do not create customer or job
- Log: "Validation failed - invalid service type"

**Scenario 3: Database Connection Error**
- Catch Prisma errors
- Return 500 with generic message
- Log full error with stack trace
- Retry logic (future enhancement)

**Scenario 4: Duplicate Idempotency Key**
- Check WebhookLog for existing key (within 24h)
- Return existing job ID with 202 status
- Do not create duplicate job
- Log: "Idempotent request - returned existing job"

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for N8N webhook integration | Sarah (Product Owner) |
| 2025-09-30 | 1.1 | Adjusted effort estimate: 5 → 7-8 days (SM review) | Sarah (Product Owner) |
| 2025-09-30 | 1.1 | Added AC11-12: Performance & Rate limiting requirements | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent during implementation)

### Debug Log References
(To be filled by Dev Agent during implementation)

### Completion Notes List
(To be filled by Dev Agent during implementation)

### File List
(To be filled by Dev Agent during implementation)

## QA Results

(To be filled by QA Agent after implementation review)