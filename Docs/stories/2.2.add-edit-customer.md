# Story 2.2: Add/Edit Customer

<!-- Powered by BMAD™ Core -->

## Status
Approved

## Story
**As an** Admin,
**I want** to add new customers to the system and edit existing customer information,
**so that** I can maintain accurate and up-to-date customer records.

## Acceptance Criteria

1. A customer creation form is accessible from the customers list page.
2. The form includes fields for customer name, phone number, address, and contact channel.
3. The system validates that phone numbers are unique across all customers.
4. Upon successful creation, the user is redirected back to the customer list with the new customer visible.
5. Existing customers can be edited by clicking on their row or an "Edit" button.
6. All form fields should have proper validation and error messaging.
7. The system should handle both create and edit operations through the same form component.

## Tasks / Subtasks

- [ ] Implement Customer API endpoints for create and update (AC: 1, 4, 5)
  - [ ] Create POST /api/customers endpoint for customer creation
  - [ ] Create PATCH /api/customers/[id] endpoint for customer updates
  - [ ] Add proper validation for required fields and phone uniqueness
  - [ ] Implement proper error handling and response formatting
  - [ ] Add Admin role authorization to both endpoints
- [ ] Create customer form component (AC: 2, 6, 7)
  - [ ] Build CustomerForm component using React Hook Form and shadcn/ui
  - [ ] Add form fields: name (required), phone (required, unique), address (optional), contactChannel (required)
  - [ ] Implement client-side validation with proper error messages
  - [ ] Support both create and edit modes in the same component
  - [ ] Add loading states and form submission handling
- [ ] Create customer creation page (AC: 1, 4)
  - [ ] Create app/(dashboard)/customers/new/page.tsx for customer creation
  - [ ] Integrate CustomerForm component in create mode
  - [ ] Implement navigation from customers list page
  - [ ] Add proper page layout with header and breadcrumbs
  - [ ] Handle successful creation with redirect to customers list
- [ ] Create customer edit page (AC: 5)
  - [ ] Create app/(dashboard)/customers/[id]/edit/page.tsx for customer editing
  - [ ] Integrate CustomerForm component in edit mode with pre-populated data
  - [ ] Implement navigation from customer list table rows
  - [ ] Add proper loading states for customer data fetching
  - [ ] Handle successful updates with redirect and success messaging
- [ ] Update customer list with navigation links (AC: 1, 5)
  - [ ] Add "Add New Customer" button linking to creation page
  - [ ] Add edit functionality to customer table rows
  - [ ] Update CustomerTable component with proper navigation
  - [ ] Ensure consistent styling and user experience

## Dev Notes

### Previous Story Insights
**[Source: Epic 2 Stories completion]**
- **Customer List Infrastructure**: Story 2.1 established customer list viewing with search functionality
- **Database Schema**: Customer model already defined with id, name, phone, address, contactChannel, createdAt, updatedAt
- **Authentication System**: Admin role-based access control already implemented from Epic 1
- **API Architecture**: Repository Pattern with service layer established for consistent data access
- **Component Library**: shadcn/ui components and consistent styling patterns ready for forms

### Data Models & Validation Requirements
**[Source: docs/Data Models.md]**
- **Customer Model Structure**:
  - id: String (UUID) - Primary Key
  - name: String - ชื่อลูกค้า (required for creation)
  - phone: String - เบอร์โทรศัพท์ (Unique, required for identification)
  - address: String (Optional) - ที่อยู่
  - contactChannel: String - ช่องทางที่ลูกค้าติดต่อเข้ามา (required)
  - createdAt: DateTime - วันที่สร้างข้อมูล
  - updatedAt: DateTime - วันที่อัปเดตล่าสุด
- **Validation Rules**: Phone number uniqueness constraint, required field validation
- **Database**: Vercel Postgres with Prisma ORM for type-safe customer operations

### API Specifications
**[Source: docs/API Specification.md, Epic 2 foundation]**
- **Customer Creation Endpoint**: POST /api/customers
  - Request: `{ "name": "string", "phone": "string", "address": "string?", "contactChannel": "string" }`
  - Response: Created customer object with full customer data
  - Authentication: Bearer token required (from NextAuth.js session)
  - Authorization: Admin role required for customer data modification
- **Customer Update Endpoint**: PATCH /api/customers/[id]
  - Request: Partial customer object with fields to update
  - Response: Updated customer object
  - Validation: Phone uniqueness check excluding current customer
- **Error Handling**: Standardized JSON error responses with field-specific validation errors

### File Locations for New Code
**[Source: docs/Source Tree Structure.md, Epic 1-2 foundation]**
- **Customer Creation Page**: apps/crm-app/app/(dashboard)/customers/new/page.tsx
- **Customer Edit Page**: apps/crm-app/app/(dashboard)/customers/[id]/edit/page.tsx
- **Customer Form Component**: apps/crm-app/components/forms/CustomerForm.tsx
- **Customer API Endpoints**: apps/crm-app/app/api/customers/route.ts (POST), apps/crm-app/app/api/customers/[id]/route.ts (PATCH)
- **Customer Service Enhancement**: apps/crm-app/lib/services/customer.ts (add create/update methods)
- **API Client Enhancement**: apps/crm-app/lib/api-client.ts (add customer CRUD methods)
- **Customer Types**: packages/types/index.ts (Customer input/output type definitions)

### Form Architecture & Components
**[Source: docs/tech-stack.md, Epic 1 implementation patterns]**
- **Form Framework**: React Hook Form v7.x for efficient form handling and validation
- **UI Components**: shadcn/ui Form, Input, Button, Label components for consistent styling
- **Validation Strategy**: Client-side validation with React Hook Form + server-side validation
- **Error Handling**: Field-level error messages and form-level error states
- **Loading States**: Form submission loading indicators and disabled states
- **Navigation**: Next.js router for programmatic navigation after form actions
- **Reusable Design**: Single CustomerForm component supporting both create and edit modes

### Authentication & Authorization Requirements
**[Source: Epic 1 Stories 1.2, 1.3 implementation]**
- **API Protection**: Admin role required for customer creation and modification endpoints
- **Page Protection**: Customer creation/edit pages restricted to Admin users only
- **Session Management**: NextAuth.js session validation with role checking
- **Unauthorized Handling**: Redirect to access denied for non-Admin users
- **Security**: No customer data exposure to unauthorized roles

### Integration with Customer List
**[Source: Story 2.1 implementation]**
- **Navigation Integration**: "Add New Customer" button in customer list toolbar
- **Table Integration**: Edit functionality integrated into customer table rows
- **Search Integration**: New/updated customers should appear in search results
- **Consistent Styling**: Match existing customer list design patterns
- **User Experience**: Smooth transitions between list view and form views

### Technical Constraints
**[Source: docs/tech-stack.md, Epic 1-2 foundation]**
- TypeScript mandatory for all customer management code
- Use established Repository Pattern for customer data access through service layer
- Follow Next.js 14+ app directory routing structure for page organization
- Maintain consistency with existing shadcn/ui component patterns
- Ensure mobile-responsive design with Tailwind CSS
- Integrate with existing authentication middleware and role-based access control

### Testing

**[Source: docs/Implementation, Security, and Standards.md#testing-strategy]**
- **Test File Locations**: apps/crm-app/__tests__/customers/ for customer form and API tests
- **Frontend Testing**: Jest + React Testing Library for CustomerForm component testing
- **Backend Testing**: Vitest for customer API endpoints and service layer testing
- **Integration Testing**: Complete customer creation/edit flow from form to database
- **Security Testing**: Verify Admin role requirement and unauthorized access blocking
- **Validation Testing**: Phone uniqueness validation, required field validation
- **Test Scenarios**:
  - Customer creation form validation and submission
  - Customer edit form pre-population and update
  - Phone number uniqueness constraint validation
  - Role-based access control verification
  - Form error handling and user feedback
  - Navigation flow between customer list and forms
  - Mobile responsive form layout testing
  - API endpoint authorization and error handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*