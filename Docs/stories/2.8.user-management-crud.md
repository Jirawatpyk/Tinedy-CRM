# Story 2.8: User Management (CRUD)

<!-- Powered by BMAD™ Core -->

## Status
Approved ✅

## Story
**As an** Admin,
**I want** to create, view, edit, and deactivate user accounts with proper role management,
**so that** I can control team access to the CRM system and manage user permissions.

## Acceptance Criteria

**Based on PRD section 2.1 (User Roles) and NFR2, NFR3 (Security requirements):**

1. User list page at /settings/users showing all users with name, email, role, and active status
2. Create new user form with fields: name, email, temporary password, role selection (ADMIN, OPERATIONS, TRAINING, QC_MANAGER)
3. Edit user functionality to update name, email, and role (cannot change own role if Admin)
4. Deactivate user functionality (soft delete) that sets isActive = false instead of hard delete
5. Cannot deactivate user if they have assigned jobs in active status (NEW, ASSIGNED, IN_PROGRESS, ON_HOLD)
6. Search and filter users by role, active status, and name/email
7. Password reset functionality to generate new temporary password for users
8. Only Admin users can access user management pages and perform CRUD operations

## Tasks / Subtasks

**Implementation tasks for complete user management:**

- [ ] Create User API endpoints (AC: 1, 2, 3, 4, 7, 8)
  - [ ] Create GET /api/users endpoint for listing users with filters
  - [ ] Create POST /api/users endpoint for creating new users
  - [ ] Create GET /api/users/[id] endpoint for user details
  - [ ] Create PATCH /api/users/[id] endpoint for updating user info
  - [ ] Create PATCH /api/users/[id]/deactivate endpoint for soft delete
  - [ ] Create POST /api/users/[id]/reset-password endpoint for password reset
  - [ ] Add Admin role authorization to all endpoints
  - [ ] Implement validation: prevent self-role change for current Admin
  - [ ] Implement validation: check assigned jobs before deactivation
  - [ ] Hash passwords using bcrypt before storing
  - [ ] Add unit tests for all API endpoints

- [ ] Build User Service layer (AC: 2, 3, 4, 5)
  - [ ] Create apps/crm-app/lib/services/user.ts with CRUD methods
  - [ ] Implement getUserById, getAllUsers with filters
  - [ ] Implement createUser with password hashing
  - [ ] Implement updateUser with role change validation
  - [ ] Implement deactivateUser with assigned job check
  - [ ] Implement resetPassword with temporary password generation
  - [ ] Add proper error handling and validation
  - [ ] Add service layer unit tests

- [ ] Create User List page and components (AC: 1, 6, 8)
  - [ ] Create apps/crm-app/app/(dashboard)/settings/users/page.tsx
  - [ ] Build UserTable component with sortable columns
  - [ ] Add role badge component with color coding (Admin=red, Operations=blue, etc.)
  - [ ] Add active/inactive status indicator
  - [ ] Implement search bar for name/email filtering
  - [ ] Add role filter dropdown (All, Admin, Operations, Training, QC Manager)
  - [ ] Add active status filter toggle
  - [ ] Include "Add New User" button
  - [ ] Add pagination if user count is high

- [ ] Build Create/Edit User forms (AC: 2, 3, 7)
  - [ ] Create UserForm component in apps/crm-app/components/shared/
  - [ ] Add form fields: name (required), email (required, unique), role (select)
  - [ ] Add temporary password field (required for new users only)
  - [ ] Use React Hook Form for form validation
  - [ ] Implement role selection dropdown with all 4 roles
  - [ ] Add "cannot change own role" logic for current Admin
  - [ ] Show password reset button on edit form
  - [ ] Display success/error messages with toast notifications
  - [ ] Handle form submission with loading states

- [ ] Implement user deactivation with safety checks (AC: 4, 5)
  - [ ] Add "Deactivate" button to user list actions
  - [ ] Add "Deactivate User" button to user detail/edit page
  - [ ] Create DeactivateUserDialog confirmation component
  - [ ] Check for assigned active jobs before deactivation
  - [ ] Show warning if user has assigned jobs with count
  - [ ] Block deactivation if active jobs exist
  - [ ] Allow deactivation if only completed/cancelled jobs
  - [ ] Show success notification after deactivation
  - [ ] Hide deactivated users from default list (filter toggle to show)

- [ ] Add comprehensive testing (All ACs)
  - [ ] API tests: Create user with valid/invalid data
  - [ ] API tests: Update user including role changes
  - [ ] API tests: Prevent Admin from changing own role
  - [ ] API tests: Deactivate user with/without active jobs
  - [ ] API tests: Password reset generates new temp password
  - [ ] API tests: Authorization (only Admin can access)
  - [ ] Service tests: Password hashing verification
  - [ ] Service tests: Assigned job count validation
  - [ ] Component tests: UserForm validation and submission
  - [ ] Component tests: Role badge color coding
  - [ ] Component tests: DeactivateUserDialog interactions
  - [ ] E2E test: Complete user creation flow
  - [ ] E2E test: Edit user and change role
  - [ ] E2E test: Deactivate user with safety checks
  - [ ] E2E test: Password reset flow

## Dev Notes

### Previous Story Insights
**[Source: Epic 1 Authentication system, Story 2.4, 2.5 implementations]**
- ✅ **NextAuth.js v5**: Authentication system with session management
- ✅ **User Model**: Basic User model with id, email, name, role, password fields
- ✅ **Role-based Authorization**: Admin check patterns established in APIs
- ✅ **Form Components**: React Hook Form + shadcn/ui patterns in previous stories
- ✅ **Service Layer Pattern**: Repository pattern with services established

**⚠️ Gap Identified**: Epic 1 created authentication but no user management UI or CRUD endpoints exist

### Data Models & Relationships
**[Source: docs/Data Models.md, prisma/schema.prisma]**

**User Model Structure:**
```prisma
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed with bcrypt
  name      String
  role      UserRole @default(OPERATIONS)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  jobs      Job[]    // Jobs assigned to this user

  @@index([email])
  @@index([isActive])
  @@index([role])
}

enum UserRole {
  ADMIN
  OPERATIONS
  TRAINING
  QC_MANAGER
}
```

**User-Job Relationship:**
- User has many Jobs (One-to-Many)
- Job.assignedUserId references User.id (Foreign Key, Optional)
- **Deactivation Rule**: Cannot deactivate user if they have jobs with status IN_PROGRESS, ASSIGNED, NEW, or ON_HOLD

### User Roles & Permissions
**[Source: PRD section 2.1 - User Roles & Permissions]**

**Role Definitions:**
1. **ADMIN**: Full system access, can manage all entities and users
2. **OPERATIONS**: Field team, can update assigned jobs and checklist status
3. **TRAINING**: Manages training workflows and courses
4. **QC_MANAGER**: Quality control oversight, read-only access with checklist view

**Role Color Coding (UI):**
- ADMIN: Red/destructive
- OPERATIONS: Blue/primary
- TRAINING: Purple/secondary
- QC_MANAGER: Green/success

### Password Security
**[Source: PRD NFR2, NFR3 - Security requirements]**

**Password Handling:**
```typescript
import bcrypt from 'bcryptjs';

// Creating new user
const hashedPassword = await bcrypt.hash(temporaryPassword, 10);

// Resetting password
const newTempPassword = generateTempPassword(); // 12 char random string
const hashedPassword = await bcrypt.hash(newTempPassword, 10);

// Send new password to user via email (future enhancement)
// For now: Display temp password in success message
```

**Password Requirements:**
- Minimum 8 characters
- Temporary passwords: 12 characters, alphanumeric + special chars
- Force password change on first login (future enhancement)

### API Specifications
**[Source: Established patterns from Story 2.1, 2.4]**

**New Endpoints:**

1. **GET /api/users**
   - Query Params: `?role=OPERATIONS&isActive=true&search=john`
   - Authorization: Admin required
   - Response: Array of User objects (password excluded)
   - Filters: role, isActive, name/email search

2. **POST /api/users**
   - Body: `{ name, email, password, role }`
   - Authorization: Admin required
   - Validation: Email unique, password min 8 chars, valid role
   - Response: Created user object (password excluded)

3. **GET /api/users/[id]**
   - Authorization: Admin required
   - Response: Single User object with assigned job count

4. **PATCH /api/users/[id]**
   - Body: `{ name?, email?, role? }`
   - Authorization: Admin required
   - Validation: Cannot change own role if current user is Admin
   - Response: Updated user object

5. **PATCH /api/users/[id]/deactivate**
   - Authorization: Admin required
   - Pre-check: No active assigned jobs
   - Action: Set isActive = false
   - Response: { message, user }

6. **POST /api/users/[id]/reset-password**
   - Authorization: Admin required
   - Action: Generate new temp password, hash and update
   - Response: { message, temporaryPassword }

### Authorization Rules
**[Source: PRD section 2.1]**
- **Admin**: Full user management capabilities
- **All Others**: Cannot access user management (403 Forbidden)
- **Special Rule**: Admin cannot change their own role (prevent lockout)

### File Locations for New Code
**[Source: docs/architecture/source-tree.md]**

**Backend (Create 6 files):**
- `apps/crm-app/app/api/users/route.ts` (GET, POST)
- `apps/crm-app/app/api/users/[id]/route.ts` (GET, PATCH)
- `apps/crm-app/app/api/users/[id]/deactivate/route.ts` (PATCH)
- `apps/crm-app/app/api/users/[id]/reset-password/route.ts` (POST)
- `apps/crm-app/lib/services/user.ts` (CREATE or EXTEND if exists)
- `apps/crm-app/lib/utils/passwordGenerator.ts` (CREATE)

**Frontend (Create 4 files, Modify 1):**
- `apps/crm-app/app/(dashboard)/settings/users/page.tsx` (CREATE)
- `apps/crm-app/components/shared/UserTable.tsx` (CREATE)
- `apps/crm-app/components/shared/UserForm.tsx` (CREATE)
- `apps/crm-app/components/shared/DeactivateUserDialog.tsx` (CREATE)
- `apps/crm-app/app/(dashboard)/settings/layout.tsx` (MODIFY - add Users to navigation)

**Testing (Create 4 files):**
- `apps/crm-app/__tests__/api/users/route.test.ts`
- `apps/crm-app/__tests__/services/user.test.ts`
- `apps/crm-app/__tests__/components/shared/UserForm.test.tsx`
- `apps/crm-app/tests/e2e/user-management.spec.ts`

### UI/UX Patterns

**[Enhanced by Luna (UX/UI Designer) - 2025-09-30]**

**Full implementation details available in:** `docs/ux-ui/updated-uiux-patterns-2.8.md`

### Design Philosophy
- **Clear Role Hierarchy**: Visual differentiation between user roles
- **Security-First UX**: Prevent accidental permission escalation
- **Guided User Creation**: Step-by-step form with inline validation
- **Safe Deactivation**: Check for active assignments before deactivation

### Key UI Components

#### User Table (Desktop View)
- Sortable columns with visual indicators
- Avatar fallbacks with user initials
- Role badges with color coding and icons (ADMIN=red, OPERATIONS=blue, TRAINING=purple, QC_MANAGER=green)
- Status badges (Active=green, Inactive=orange)
- Assigned job count for Operations role
- Actions dropdown with contextual options

#### Mobile Card Layout (375px)
- Stacked vertical layout for readability
- Touch-friendly buttons (44px minimum targets)
- Condensed information hierarchy
- Quick action buttons at bottom of each card

#### Role Badge Component
Visual design with color coding and icons:
```tsx
ADMIN: { label: 'Admin', icon: Shield, color: 'red', description: 'Full system access' }
OPERATIONS: { label: 'Operations', icon: Wrench, color: 'blue', description: 'Job management' }
TRAINING: { label: 'Training', icon: GraduationCap, color: 'purple', description: 'Training workflows' }
QC_MANAGER: { label: 'QC Manager', icon: CheckCircle2, color: 'green', description: 'Quality control' }
```

#### Add/Edit User Form Features
- Full name (required)
- Email with real-time uniqueness validation
- Temporary password generator with strength indicator
- Password show/hide toggle
- Copy password to clipboard
- Role selection with radio buttons showing descriptions
- Send welcome email option (checkbox)
- Cannot change own role protection for current Admin

#### Password Strength Indicator
5-level strength meter with visual feedback:
- Very Weak (20%, red)
- Weak (40%, orange)
- Fair (60%, yellow)
- Good (80%, lime)
- Strong (100%, green)

#### Password Reset Dialog
- Two-phase flow: Generate → Display with copy option
- Auto-copy checkbox for convenience
- Show password in dialog option
- Type-to-confirm not required (less critical than deletion)
- Email notification confirmation

#### Deactivate User Safety Checks
- Check for active assigned jobs before deactivation
- Show detailed job list if blocking
- Offer "Reassign All Jobs" option
- Clear explanation of deactivation consequences
- Undo option in success toast

#### Search and Filter Bar
- Search by name or email with clear button
- Role filter dropdown with icons
- Active/Inactive toggle buttons
- Active filters display with individual remove buttons
- "Clear All Filters" convenience button
- Results count announcement for screen readers

### Accessibility Features
- Keyboard shortcuts: Cmd/Ctrl+K (focus search), Cmd/Ctrl+N (add user)
- All interactive elements have ARIA labels
- Focus indicators visible on all elements
- Screen reader announcements for filter changes
- Logical tab order throughout forms
- Form validation errors announced
- Success/error toasts with aria-live regions

### Component File Structure
```
apps/crm-app/components/shared/
├── UserTable.tsx                    (Main table component)
├── UserCard.tsx                     (Mobile card view)
├── UserForm.tsx                     (Create/Edit form)
├── UserActionsDropdown.tsx          (Actions menu)
├── RoleBadge.tsx                    (Role indicator)
├── StatusBadge.tsx                  (Active/Inactive badge)
├── DeactivateUserDialog.tsx         (Deactivation confirmation)
├── ResetPasswordDialog.tsx          (Password reset)
└── PasswordStrengthIndicator.tsx    (Password strength meter)
```

### Implementation Checklist (17 items)
- [ ] Install shadcn/ui components: dialog, radio-group, checkbox, avatar, tooltip
- [ ] Create user management page at /settings/users
- [ ] Implement UserTable with sortable columns
- [ ] Create UserForm with role selection and validation
- [ ] Build RoleBadge with color coding and icons
- [ ] Implement StatusBadge for active/inactive display
- [ ] Create ResetPasswordDialog with copy functionality
- [ ] Build DeactivateUserDialog with job check
- [ ] Add search and filter functionality
- [ ] Implement email uniqueness check
- [ ] Add password generator utility
- [ ] Create PasswordStrengthIndicator component
- [ ] Implement keyboard shortcuts (Cmd+K, Cmd+N)
- [ ] Add ARIA labels and screen reader support
- [ ] Test mobile responsive layout (375px to 1920px)
- [ ] Verify touch targets are 44px minimum
- [ ] Test with keyboard navigation only
- [ ] Test with screen readers (NVDA/JAWS)

### Technical Constraints
**[Source: docs/architecture/tech-stack.md, CLAUDE.md]**
- TypeScript mandatory
- Use Prisma ORM for User model operations
- Use bcrypt/bcryptjs for password hashing (salt rounds: 10)
- Follow Repository Pattern through UserService
- Use NextAuth.js session for authorization
- Use shadcn/ui components (Table, Form, Badge, Dialog)
- Use React Hook Form + Zod for validation
- Ensure mobile-responsive layout

### Integration Points
**[Source: Epic 1 authentication, Story 2.4 job management]**
- **Authentication System**: Uses existing NextAuth session
- **Job Assignment**: User dropdown in job forms uses this API (GET /api/users?role=OPERATIONS)
- **Settings Navigation**: Add "Users" link to settings sidebar
- **Audit Logging**: Track user creation/modification (future)

### Testing

**[Source: docs/architecture/tech-stack.md]**

**Test File Locations:**
- Backend: `apps/crm-app/__tests__/api/users/*.test.ts`
- Service: `apps/crm-app/__tests__/services/user.test.ts`
- Component: `apps/crm-app/__tests__/components/shared/User*.test.tsx`
- E2E: `apps/crm-app/tests/e2e/user-management.spec.ts`

**Testing Frameworks:**
- Backend: Vitest
- Frontend: Jest + React Testing Library
- E2E: Playwright

**Test Scenarios:**

1. **User Creation Tests** (8 tests):
   - Create user with valid data succeeds
   - Create user with duplicate email fails
   - Create user with invalid email fails
   - Create user with weak password fails
   - Password is hashed in database
   - New user has default isActive=true
   - Only Admin can create users (403 for others)
   - Created user appears in user list

2. **User Update Tests** (6 tests):
   - Update user name/email succeeds
   - Update user role succeeds
   - Admin cannot change own role (blocked)
   - Email uniqueness validated on update
   - Only Admin can update (403 for others)
   - Updated user reflects changes immediately

3. **User Deactivation Tests** (6 tests):
   - Deactivate user with no jobs succeeds
   - Deactivate user with completed jobs succeeds
   - Cannot deactivate user with active assigned jobs
   - Deactivated user isActive=false
   - Deactivated users hidden from default list
   - Can filter to show deactivated users

4. **Password Reset Tests** (4 tests):
   - Reset generates new temporary password
   - New password is hashed correctly
   - Temp password meets strength requirements
   - Only Admin can reset passwords

5. **Authorization Tests** (5 tests):
   - Admin can access all user endpoints
   - Operations cannot access user management (403)
   - Unauthenticated returns 401
   - Manager/QC cannot access user management
   - Training role cannot access user management

6. **UI Component Tests** (8 tests):
   - UserForm validates required fields
   - Role dropdown shows all 4 roles
   - Email validation displays errors
   - Cannot submit form with invalid data
   - UserTable renders users with badges
   - Role badges display correct colors
   - Search filter works correctly
   - DeactivateUserDialog shows job count warning

7. **E2E Tests** (5 tests):
   - Complete user creation workflow
   - Edit user and change role
   - Deactivate user (blocked by active jobs)
   - Deactivate user (succeeds with no jobs)
   - Password reset and copy temp password

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for user management CRUD | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent during implementation)

### Debug Log References
(To be filled by Dev Agent during implementation)

### Completion Notes List
(To be filled by Dev Agent during implementation)

### File List
(To be filled by Dev Agent during implementation)

## QA Results

(To be filled by QA Agent after implementation review)