# Story 2.9: Delete Job with Cascade Handling

<!-- Powered by BMAD™ Core -->

## Status
Approved ✅

## Story
**As an** Admin,
**I want** to delete jobs with proper cascade handling and safety validations,
**so that** I can remove incorrect, duplicate, or test job entries without data corruption.

## Acceptance Criteria

**Based on PRD FR5-FR9 and User Roles section 2.1:**

1. Delete button is available on job detail page (Admin role only)
2. System prevents deletion of jobs with status IN_PROGRESS or COMPLETED (business rule: preserve work history)
3. Before deletion, system shows confirmation dialog with job details (Job ID, customer name, service type, status)
4. If job has attached checklist data (itemStatus), system warns and cascade deletes checklist data
5. Hard delete removes job record and all associated checklist data (itemStatus, checklistTemplateId)
6. Deleted jobs maintain audit trail with deletion timestamp and admin user who performed the action
7. After successful deletion, user is redirected to appropriate page (job list or customer detail) with success notification
8. Cannot delete job if it's the only job for a customer and customer status is based on this job

## Tasks / Subtasks

**Implementation tasks for job deletion with cascade handling:**

- [ ] Add delete functionality to Job API (AC: 1, 2, 4, 5, 6)
  - [ ] Create DELETE /api/jobs/[id] endpoint in apps/crm-app/app/api/jobs/[id]/route.ts
  - [ ] Add Admin role authorization check
  - [ ] Implement status validation (prevent delete if IN_PROGRESS or COMPLETED)
  - [ ] Check for attached checklist data (itemStatus field)
  - [ ] Cascade delete: Clear itemStatus, checklistTemplateId, checklistCompletedAt
  - [ ] Create audit log entry with deletion details
  - [ ] Return appropriate error messages for failed deletions
  - [ ] Add unit tests for all delete scenarios

- [ ] Implement business rule validations (AC: 2, 8)
  - [ ] Add canDeleteJob validation in JobService
  - [ ] Block deletion for IN_PROGRESS jobs (active work)
  - [ ] Block deletion for COMPLETED jobs (historical record)
  - [ ] Allow deletion for NEW, ASSIGNED, ON_HOLD, CANCELLED statuses
  - [ ] Check if job is customer's only job (optional validation)
  - [ ] Return detailed error messages for each validation failure
  - [ ] Add service layer tests for validation logic

- [ ] Build delete confirmation UI component (AC: 3, 4, 7)
  - [ ] Create DeleteJobDialog component in apps/crm-app/components/shared/
  - [ ] Display job ID, customer name, service type, status, scheduled date
  - [ ] Show warning if job has checklist data attached
  - [ ] List checklist items that will be deleted
  - [ ] Implement confirmation with "Delete Job" and "Cancel" buttons
  - [ ] Add loading state during deletion API call
  - [ ] Show error messages if deletion fails (status restriction)
  - [ ] Display success toast notification on successful deletion

- [ ] Integrate delete button in UI (AC: 1)
  - [ ] Add delete button to job detail page header
  - [ ] Only show delete button for Admin users
  - [ ] Disable delete button if job status is IN_PROGRESS or COMPLETED
  - [ ] Show tooltip explaining why delete is disabled
  - [ ] Implement redirect logic (to job list or customer detail based on context)
  - [ ] Add confirmation before navigation

- [ ] Add comprehensive testing (All ACs)
  - [ ] API tests: Delete NEW job (should succeed)
  - [ ] API tests: Delete ASSIGNED job (should succeed)
  - [ ] API tests: Delete IN_PROGRESS job (should fail)
  - [ ] API tests: Delete COMPLETED job (should fail)
  - [ ] API tests: Delete job with checklist data (cascade succeeds)
  - [ ] API tests: Authorization (non-Admin cannot delete)
  - [ ] Component tests: DeleteJobDialog rendering and interactions
  - [ ] Component tests: Delete button visibility based on role and status
  - [ ] E2E test: Complete deletion flow from job detail page
  - [ ] E2E test: Deletion blocked by status restriction with error message

## Dev Notes

### Previous Story Insights
**[Source: Story 2.4 Job Details Management, Story 2.5 Checklist Management]**
- ✅ **Job CRUD Infrastructure**: Complete create, read, update functionality
- ✅ **Job API Endpoints**: GET, POST, PATCH already implemented
- ✅ **Job Service Layer**: `apps/crm-app/lib/services/job.ts` with CRUD methods
- ✅ **Checklist Integration**: Story 2.5 added itemStatus, checklistTemplateId, checklistCompletedAt fields to Job model
- ✅ **Role-based Authorization**: Admin-only patterns established
- ✅ **UI Components**: Job detail page, status dropdown, assignment dropdown ready

### Data Models & Relationships
**[Source: docs/Data Models.md, prisma/schema.prisma, Story 2.5]**

**Job Model with Checklist Fields:**
```prisma
model Job {
  id                    String      @id @default(cuid())
  customerId            String
  serviceType           ServiceType
  scheduledDate         DateTime
  price                 Decimal     @db.Decimal(10, 2)
  status                JobStatus   @default(NEW)
  notes                 String?
  assignedUserId        String?
  description           String?
  priority              Priority    @default(MEDIUM)
  completedAt           DateTime?

  // Story 2.5: Checklist fields
  checklistTemplateId   String?     // Foreign key to ChecklistTemplate
  itemStatus            Json?       // Record<string, boolean> for item completion
  checklistCompletedAt  DateTime?   // When checklist was completed

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  // Relations
  customer              Customer    @relation(fields: [customerId], references: [id])
  assignedUser          User?       @relation(fields: [assignedUserId], references: [id])
  checklistTemplate     ChecklistTemplate? @relation(fields: [checklistTemplateId], references: [id])

  @@index([customerId])
  @@index([assignedUserId])
  @@index([status])
}
```

**Deletion Rules:**
1. **Status-based**: Cannot delete IN_PROGRESS or COMPLETED jobs (preserve work history)
2. **Cascade**: Delete checklist data (itemStatus, checklistTemplateId, checklistCompletedAt)
3. **Customer relationship**: Foreign key allows deletion (no cascade to customer)

### Deletion Safety Logic
**[Source: Best practices, Story 2.4, 2.5 patterns]**

**Pre-deletion Validation:**
```typescript
// Check job status
const job = await prisma.job.findUnique({
  where: { id },
  include: { customer: true, checklistTemplate: true }
});

if (job.status === 'IN_PROGRESS') {
  return { error: 'Cannot delete job in progress. Active work must be completed first.', status: 400 };
}

if (job.status === 'COMPLETED') {
  return { error: 'Cannot delete completed job. Historical records must be preserved.', status: 400 };
}

// Check for checklist data
const hasChecklistData = job.itemStatus !== null || job.checklistTemplateId !== null;
if (hasChecklistData) {
  // Warn user, but allow deletion with cascade
  console.log(`Deleting job with checklist data. Template: ${job.checklistTemplateId}`);
}
```

**Allowed Deletion Statuses:**
- ✅ NEW - Job not yet started
- ✅ ASSIGNED - Job assigned but not started
- ✅ ON_HOLD - Job paused
- ✅ CANCELLED - Job cancelled
- ❌ IN_PROGRESS - Active work (preserve)
- ❌ COMPLETED - Historical record (preserve)

### API Specifications
**[Source: Established patterns from Story 2.4]**

**New DELETE Handler:**

**DELETE /api/jobs/[id]**
- Authorization: Admin role required
- Pre-checks:
  - Status not IN_PROGRESS
  - Status not COMPLETED
- Cascade: Automatically clears checklist fields (Prisma handles this)
- Audit: Log deletion with user ID and timestamp
- Response Success: { message: "Job deleted successfully", jobId: string }
- Response Error: { error: string, status: string }
- Status Codes:
  - 200: Deletion successful
  - 400: Invalid status for deletion
  - 403: Not authorized (non-Admin)
  - 404: Job not found

### Authorization Rules
**[Source: PRD section 2.1 - User Roles & Permissions]**
- **Admin**: Can delete jobs (with status restrictions)
- **Operations/Manager/QC**: Cannot delete jobs (read-only or update-only)
- Implementation: Check `session?.user?.role === 'ADMIN'`

### File Locations for New Code
**[Source: docs/architecture/source-tree.md, existing patterns]**

**Backend:**
- **Modify API Route**: `apps/crm-app/app/api/jobs/[id]/route.ts` (add DELETE handler)
- **Job Service**: `apps/crm-app/lib/services/job.ts` (add deleteJob, canDeleteJob methods)
- **Audit Logger** (future): `apps/crm-app/lib/services/auditLog.ts`

**Frontend:**
- **Delete Dialog Component**: `apps/crm-app/components/shared/DeleteJobDialog.tsx` (CREATE)
- **Job Detail Page**: `apps/crm-app/app/(dashboard)/jobs/[id]/page.tsx` (MODIFY - add delete button)
- **Job Management Component**: `apps/crm-app/components/jobs/JobDetailsManagement.tsx` (MODIFY if needed)

**Testing:**
- **API Tests**: `apps/crm-app/__tests__/api/jobs/[id]/route.test.ts` (MODIFY - add DELETE tests)
- **Service Tests**: `apps/crm-app/__tests__/services/job.test.ts` (MODIFY - add deleteJob tests)
- **Component Tests**: `apps/crm-app/__tests__/components/shared/DeleteJobDialog.test.tsx` (CREATE)
- **E2E Tests**: `apps/crm-app/tests/e2e/job-deletion.spec.ts` (CREATE)

### UI/UX Patterns

**[Enhanced by Luna (UX/UI Designer) - 2025-09-30]**

**Full implementation details available in:** `docs/ux-ui/updated-uiux-patterns-2.9.md`

### Design Philosophy
- **Context-Aware Confirmation**: Show full job details to prevent accidental deletion
- **Transparent Cascade Impact**: Clearly show what checklist data will be lost
- **Smart Blocking**: Explain why deletion is blocked and suggest alternatives
- **Guided Navigation**: Let users choose where to go after deletion

### Key UI Components

#### Delete Button Placement
- Job Detail Page header with responsive layout
- Shown only for Admin users
- Status-based disabled state with explanatory tooltips
- Mobile: Collapse into dropdown menu for space efficiency

#### Status-Based Delete Rules
Helper functions to determine deleteability:
```tsx
const deletableStatuses: JobStatus[] = ['NEW', 'ASSIGNED', 'ON_HOLD', 'CANCELLED'];
// IN_PROGRESS: Active work must be completed
// COMPLETED: Historical records must be preserved
```

#### Two-Step Delete Confirmation Flow

**Step 1: Context-Rich Warning Dialog**
- Full job details card (ID, status, customer, service type, date, price, assigned user)
- Checklist data warning if exists (with expandable details)
- Progress indicator for checklist completion
- Expandable checklist items preview (scrollable with checkmarks)
- Impact summary (what will be deleted)
- Redirect choice with radio buttons (Job List, Customer Detail, Dashboard)
- "Remember my choice" checkbox for future deletions
- Cannot undo warning banner

**Step 2: Final Confirmation with Type-to-Confirm**
- Destructive warning banner
- Summary of checklist data loss (if applicable)
- Type "DELETE" to confirm input field
- Redirect destination reminder
- Loading state during deletion

#### Blocked Deletion Dialog with Alternatives
When deletion is blocked by status:
- Clear explanation why deletion is blocked
- Status badge showing current job status
- Alternative action buttons:
  - For IN_PROGRESS: "Put On Hold", "Cancel Job", "Complete Job"
  - For COMPLETED: "Contact Administrator" option
- Each action shows impact hint (e.g., "Then can delete")

#### Job Status Badge Component
Color-coded badges with icons:
```tsx
NEW: Yellow (Plus icon) - can delete
ASSIGNED: Blue (UserCheck icon) - can delete
IN_PROGRESS: Purple (Clock icon) - CANNOT delete
ON_HOLD: Orange (Pause icon) - can delete
COMPLETED: Green (CheckCircle2 icon) - CANNOT delete
CANCELLED: Gray (XCircle icon) - can delete
```

#### Checklist Preview Component
- Scrollable area (max height 60vh) with checkmark indicators
- Completed items shown with line-through and timestamp
- Progress bar showing completion percentage
- Item descriptions and completion dates

### Success and Error Feedback
- Success toast with job ID and redirect confirmation
- Checklist data removal notification in toast
- Error toast with blocked status explanation
- Alternative actions button in error toast

### Mobile Responsive Design
- Delete button moves to dropdown menu on mobile (<640px)
- Dialog layout adjusts padding and spacing
- Touch-friendly 44px minimum button targets
- Stacked vertical buttons on mobile
- Scrollable content areas for long checklists

### Accessibility Features
- Keyboard shortcuts: Escape to cancel at any step
- Screen reader announcements for deletion result and redirect
- ARIA labels on all interactive elements
- Focus management in dialogs (auto-focus on safe actions)
- Logical tab order throughout flow
- Disabled button reasons announced to screen readers

### Component File Structure
```
apps/crm-app/components/shared/
├── DeleteJobDialog.tsx              (Main deletion dialog)
├── JobStatusBadge.tsx               (Status indicator)
├── ChecklistPreview.tsx             (Checklist items display)
└── DeleteBlockedDialog.tsx          (Blocked deletion with alternatives)
```

### Helper Functions
- `getRedirectLabel()`: Format redirect destination
- `getRedirectPath()`: Get router path based on choice
- `getStatusBlockMessage()`: Get blocked reason by status
- `calculateChecklistCompletion()`: Calculate progress percentage

### Implementation Checklist (19 items)
- [ ] Install shadcn/ui components: dialog, alert-dialog, progress, scroll-area, radio-group
- [ ] Create DeleteJobDialog component with two-step confirmation
- [ ] Create JobStatusBadge component with color coding
- [ ] Build ChecklistPreview component with progress indicator
- [ ] Create DeleteBlockedDialog with alternative actions
- [ ] Add delete button to job detail page header
- [ ] Implement status-based delete validation
- [ ] Add checklist data detection and warning
- [ ] Implement redirect choice with user preference storage
- [ ] Create type-to-confirm final confirmation
- [ ] Add keyboard shortcuts (Escape to cancel)
- [ ] Implement screen reader announcements
- [ ] Add ARIA labels for accessibility
- [ ] Test mobile responsive layout (375px to 1920px)
- [ ] Verify touch targets are 44px minimum
- [ ] Test keyboard navigation without mouse
- [ ] Test with screen readers (NVDA/JAWS)
- [ ] Implement success/error toast notifications
- [ ] Add loading states for async operations

### Technical Constraints
**[Source: docs/architecture/tech-stack.md, CLAUDE.md]**
- TypeScript mandatory for all code
- Use Prisma ORM for database operations (cascade handled by Prisma)
- Follow Repository Pattern through service layer
- Use NextAuth.js v5 for authentication
- Use shadcn/ui components (AlertDialog, Button, Alert, Tooltip)
- Maintain consistency with existing API response formats
- Ensure mobile-responsive design with Tailwind CSS
- Implement proper error handling and user feedback

### Integration Points
**[Source: Story 2.4, 2.5 implementations]**
- **Existing Job Service**: Extend with delete methods
- **Existing Job API**: Add DELETE handler to existing route
- **Existing Job Detail Page**: Integrate delete button in header
- **Story 2.5 Checklist**: Respect checklist data when deleting
- **Existing Auth Middleware**: Use established Admin-only patterns
- **Existing Toast System**: Use for success/error notifications

### Cascade Delete Strategy
**[Source: Story 2.5 checklist implementation]**

**Fields to Clear on Delete:**
1. `checklistTemplateId` - Reference to template
2. `itemStatus` - JSON object with item completion status
3. `checklistCompletedAt` - Completion timestamp

**Prisma will handle cascade automatically:**
```typescript
// Simple delete - Prisma handles checklist field cleanup
await prisma.job.delete({
  where: { id }
});

// The foreign key relationship automatically clears related fields
// No need for manual cascade updates to ChecklistTemplate
```

**ChecklistTemplate Relationship:**
- Job deletion does NOT delete the ChecklistTemplate
- Template remains available for other jobs
- Only the job's reference to the template is removed

### Testing

**[Source: docs/architecture/tech-stack.md, established testing patterns]**

**Test File Locations:**
- Backend API Tests: `apps/crm-app/__tests__/api/jobs/[id]/route.test.ts`
- Service Tests: `apps/crm-app/__tests__/services/job.test.ts`
- Component Tests: `apps/crm-app/__tests__/components/shared/DeleteJobDialog.test.tsx`
- E2E Tests: `apps/crm-app/tests/e2e/job-deletion.spec.ts`

**Testing Frameworks:**
- Backend: Vitest for API and service testing
- Frontend: Jest + React Testing Library for components
- E2E: Playwright for full user workflows

**Test Scenarios:**

1. **Authorization Tests** (4 tests):
   - Admin can access delete endpoint
   - Operations user cannot delete (403)
   - Unauthenticated user cannot delete (401)
   - Only Admin sees delete button in UI

2. **Status Validation Tests** (6 tests):
   - Can delete NEW job
   - Can delete ASSIGNED job
   - Can delete ON_HOLD job
   - Can delete CANCELLED job
   - Cannot delete IN_PROGRESS job (400)
   - Cannot delete COMPLETED job (400)

3. **Cascade Delete Tests** (4 tests):
   - Delete job with no checklist data succeeds
   - Delete job with checklist data succeeds (cascade)
   - Checklist template remains after job deletion
   - itemStatus cleared after deletion

4. **UI Component Tests** (6 tests):
   - DeleteJobDialog renders with job details
   - Shows checklist warning if data exists
   - Cancel button closes dialog without action
   - Delete button calls API with correct job ID
   - Delete button disabled for IN_PROGRESS/COMPLETED jobs
   - Tooltip shows reason for disabled state

5. **E2E Tests** (5 tests):
   - Complete flow: Delete job with NEW status
   - Complete flow: Delete job with checklist data
   - Attempt delete IN_PROGRESS job (blocked with error)
   - Attempt delete COMPLETED job (blocked with error)
   - Verify redirect to job list after deletion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for job deletion with cascade handling | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent during implementation)

### Debug Log References
(To be filled by Dev Agent during implementation)

### Completion Notes List
(To be filled by Dev Agent during implementation)

### File List
(To be filled by Dev Agent during implementation)

## QA Results

(To be filled by QA Agent after implementation review)