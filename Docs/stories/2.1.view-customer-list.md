# Story 2.1: View Customer List

<!-- Powered by BMAD™ Core -->

## Status
Approved

## Story
**As an** Admin,
**I want** to see a list of all customers in the system,
**so that** I can get an overview of the customer base.

## Acceptance Criteria

1. A new page is created at /customers.
2. The page displays a table with all customers from the database.
3. The table shows at least the Customer's Name and Phone Number.
4. The page includes a search bar to filter customers by name or phone number.
5. The page has a clear "Add New Customer" button.

## Tasks / Subtasks

- [ ] Implement Customer database model and API endpoint (AC: 2)
  - [ ] Verify Customer model in Prisma schema matches requirements (id, name, phone, address, contactChannel, createdAt, updatedAt)
  - [ ] Implement GET /api/customers endpoint with proper authentication
  - [ ] Add customer service layer for database operations
  - [ ] Add proper error handling and response formatting
- [ ] Create customers page route and layout (AC: 1)
  - [ ] Create app/(dashboard)/customers/page.tsx customers page
  - [ ] Add customers navigation item to dashboard layout
  - [ ] Apply role-based access control (Admin access required)
  - [ ] Implement proper page layout with header and breadcrumbs
- [ ] Build customer list table component (AC: 2, 3)
  - [ ] Create CustomerTable component using shadcn/ui Table
  - [ ] Display customer name, phone number, and additional fields
  - [ ] Implement loading states and error handling
  - [ ] Add proper TypeScript types for customer data
- [ ] Implement search and filter functionality (AC: 4)
  - [ ] Create search input component with real-time filtering
  - [ ] Implement client-side search by name and phone number
  - [ ] Add debouncing for search performance
  - [ ] Show search results count and clear search option
- [ ] Add "Add New Customer" button and navigation (AC: 5)
  - [ ] Create prominent "Add New Customer" button
  - [ ] Implement navigation to customer creation page (prepare for Story 2.2)
  - [ ] Apply proper styling and positioning
  - [ ] Add appropriate icons and visual feedback

## Dev Notes

### Previous Story Insights
**[Source: Epic 1 Stories completion]**
- **Authentication System**: NextAuth.js v5 fully implemented with JWT sessions
- **Role-Based Access**: Admin/Operations/Manager roles established with middleware protection
- **Database Infrastructure**: Vercel Postgres + Prisma ORM ready for data operations
- **Project Structure**: Monorepo with Next.js 14+, TypeScript, Tailwind CSS, shadcn/ui configured
- **API Architecture**: Repository Pattern with service layer for data access established

### Data Models & Database Schema
**[Source: docs/Data Models.md]**
- **Customer Model Structure**:
  - id: String (UUID) - Primary Key
  - name: String - ชื่อลูกค้า (required for display)
  - phone: String - เบอร์โทรศัพท์ (Unique, required for search)
  - address: String (Optional) - ที่อยู่
  - contactChannel: String - ช่องทางที่ลูกค้าติดต่อเข้ามา
  - createdAt: DateTime - วันที่สร้างข้อมูล
  - updatedAt: DateTime - วันที่อัปเดตล่าสุด
- **Database**: Vercel Postgres with Prisma ORM for type-safe customer queries
- **Relationships**: Customer หนึ่งคนสามารถมี Jobs หลายรายการ (One-to-Many)

### API Specifications
**[Source: docs/API Specification.md]**
- **Customer List Endpoint**: GET /api/customers
  - Response: Array of customer objects with full customer data
  - Authentication: Bearer token required (from NextAuth.js session)
  - Authorization: Admin role required for customer data access
  - Error Handling: Standardized JSON error responses
- **Security**: Role-based access control with Admin permissions required
- **Response Format**: Consistent API response structure with customer array

### File Locations for New Code
**[Source: docs/Source Tree Structure.md, Epic 1 foundation]**
- **Customers Page**: apps/crm-app/app/(dashboard)/customers/page.tsx
- **Customer API**: apps/crm-app/app/api/customers/route.ts
- **Customer Service**: apps/crm-app/lib/services/customer.ts
- **Customer Table Component**: apps/crm-app/components/shared/CustomerTable.tsx
- **Search Component**: apps/crm-app/components/shared/SearchInput.tsx
- **API Client**: apps/crm-app/lib/api-client.ts (customer methods)
- **Customer Types**: packages/types/index.ts (Customer interface definitions)

### UI/UX Architecture & Components
**[Source: docs/tech-stack.md, Epic 1 implementation]**
- **Table Component**: Use shadcn/ui Table components for consistent styling
- **Search Interface**: Real-time search with debouncing for performance
- **Navigation Integration**: Add to existing dashboard navigation structure
- **Responsive Design**: Tailwind CSS responsive table layout
- **Loading States**: Skeleton components and loading indicators
- **Button Components**: shadcn/ui Button for "Add New Customer" action
- **Icons**: Lucide React icons for search, add, and table actions

### Authentication & Authorization Requirements
**[Source: Epic 1 Stories 1.2, 1.3 implementation]**
- **Page Protection**: Use role-based middleware to restrict Admin access
- **API Protection**: NextAuth.js session validation with Admin role check
- **Session Management**: Access user role from NextAuth.js JWT token
- **Unauthorized Handling**: Redirect to access denied page for non-Admin users
- **Security**: No customer data exposure to unauthorized roles

### Search & Filter Implementation
**[Source: docs/Implementation, Security, and Standards.md]**
- **Client-Side Search**: Filter customer array by name and phone number
- **Performance**: Debounce search input (300ms) to prevent excessive filtering
- **Search Algorithm**: Case-insensitive partial matching for name and phone
- **User Experience**: Show results count, clear search, no results message
- **Accessibility**: Proper ARIA labels and keyboard navigation

### Technical Constraints
**[Source: docs/tech-stack.md, Epic 1 foundation]**
- TypeScript mandatory for all customer management code
- Use established Repository Pattern for customer data access
- Follow Next.js 14+ app directory routing structure
- Maintain consistency with existing shadcn/ui component patterns
- Ensure mobile-responsive design with Tailwind CSS

### Testing

**[Source: docs/Implementation, Security, and Standards.md#testing-strategy]**
- **Test File Locations**: apps/crm-app/__tests__/customers/ for customer-related tests
- **Frontend Testing**: Jest + React Testing Library for CustomerTable and search components
- **Backend Testing**: Vitest for customer API endpoint and service layer testing
- **Integration Testing**: Complete customer list flow from API to UI rendering
- **Security Testing**: Verify Admin role requirement and unauthorized access blocking
- **Performance Testing**: Search functionality performance with large customer datasets
- **Test Scenarios**:
  - Customer list loading and display
  - Search functionality with various query types
  - Role-based access control verification
  - Error handling for API failures
  - Add New Customer button navigation
  - Mobile responsive layout testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-27 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by QA Agent after story completion*