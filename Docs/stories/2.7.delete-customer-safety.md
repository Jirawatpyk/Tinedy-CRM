# Story 2.7: Delete Customer with Safety Checks

<!-- Powered by BMAD™ Core -->

## Status
Approved ✅

## Story
**As an** Admin,
**I want** to safely delete customers with proper validation and warnings,
**so that** I can remove invalid or duplicate customer records without breaking job relationships.

## Acceptance Criteria

**Based on PRD FR1-FR4 and User Roles section 2.1:**

1. Delete button is available on customer list and customer detail pages (Admin role only)
2. System prevents deletion of customers who have active jobs (status IN_PROGRESS, ASSIGNED, or NEW)
3. Before deletion, system shows warning dialog with customer name and count of associated jobs
4. Soft delete option available: Mark customer as INACTIVE instead of hard delete
5. Hard delete only allowed if customer has no jobs OR all jobs are COMPLETED/CANCELLED
6. Deleted customers maintain audit trail with deletion timestamp and admin user who performed the action
7. After successful deletion, user is redirected to customer list with success notification

## Tasks / Subtasks

**Implementation tasks for customer deletion with safety:**

- [ ] Add delete functionality to Customer API (AC: 1, 2, 5, 6)
  - [ ] Create DELETE /api/customers/[id] endpoint in apps/crm-app/app/api/customers/[id]/route.ts
  - [ ] Add Admin role authorization check
  - [ ] Implement job relationship validation (check for active jobs)
  - [ ] Add soft delete support (update status to INACTIVE)
  - [ ] Add hard delete with cascade check (only if no jobs or all completed/cancelled)
  - [ ] Create audit log entry with deletion details
  - [ ] Return appropriate error messages for failed deletions
  - [ ] Add unit tests for all delete scenarios

- [ ] Create soft delete (deactivate) functionality (AC: 4)
  - [ ] Add CustomerStatus enum: ACTIVE, INACTIVE, BLOCKED (if not exists)
  - [ ] Create PATCH /api/customers/[id]/deactivate endpoint
  - [ ] Update customer list to filter out INACTIVE customers by default
  - [ ] Add "Show Inactive" toggle on customer list
  - [ ] Display inactive status badge on customer records
  - [ ] Allow reactivation of INACTIVE customers

- [ ] Build delete confirmation UI components (AC: 3, 7)
  - [ ] Create DeleteCustomerDialog component in apps/crm-app/components/shared/
  - [ ] Display customer name, phone, and associated job count
  - [ ] Show different messages for soft delete vs hard delete options
  - [ ] Implement confirmation with "Delete" and "Cancel" buttons
  - [ ] Add loading state during deletion API call
  - [ ] Show error messages if deletion fails (active jobs exist)
  - [ ] Display success toast notification on successful deletion

- [ ] Integrate delete buttons in UI (AC: 1)
  - [ ] Add delete button to customer list table (with confirmation)
  - [ ] Add delete button to customer detail page header
  - [ ] Only show delete buttons for Admin users
  - [ ] Disable delete button if customer has active jobs
  - [ ] Show tooltip explaining why delete is disabled
  - [ ] Implement redirect to customer list after deletion

- [ ] Add comprehensive testing (All ACs)
  - [ ] API tests: Delete with active jobs (should fail)
  - [ ] API tests: Delete with no jobs (should succeed)
  - [ ] API tests: Delete with only completed jobs (should succeed)
  - [ ] API tests: Soft delete (mark INACTIVE)
  - [ ] API tests: Authorization (non-Admin cannot delete)
  - [ ] Component tests: DeleteCustomerDialog rendering and interactions
  - [ ] Component tests: Delete button visibility based on role
  - [ ] E2E test: Complete deletion flow from customer list
  - [ ] E2E test: Deletion blocked by active jobs with error message

## Dev Notes

### Previous Story Insights
**[Source: Story 2.1, 2.2, 2.3 - Customer Management implementation]**
- ✅ **Customer CRUD Infrastructure**: Complete list, add, edit, and view functionality
- ✅ **Customer API Endpoints**: GET, POST, PATCH already implemented
- ✅ **Customer Service Layer**: `apps/crm-app/lib/services/customer.ts` with CRUD methods
- ✅ **Customer-Job Relationships**: Job records link to customers via `customerId`
- ✅ **Role-based Authorization**: Admin-only patterns established
- ✅ **UI Components**: Customer list table, forms, and detail views ready

### Data Models & Relationships
**[Source: docs/Data Models.md, prisma/schema.prisma]**
- **Customer Model**:
  - id: String (UUID) - Primary Key
  - name: String - Customer name
  - phone: String (Unique) - Phone number
  - address: String (Optional) - Address
  - contactChannel: String - Contact method
  - status: CustomerStatus enum - ACTIVE, INACTIVE, BLOCKED
  - createdAt: DateTime
  - updatedAt: DateTime
- **Customer-Job Relationship**:
  - Customer has many Jobs (One-to-Many)
  - Job.customerId references Customer.id (Foreign Key)
  - **Deletion Rule**: Cannot delete customer if they have active jobs

### Deletion Safety Logic
**[Source: PRD User Roles section 2.1, Best practices]**

**Safety Checks (Pre-deletion validation):**
```typescript
// Check for active jobs
const activeJobs = await prisma.job.count({
  where: {
    customerId: id,
    status: { in: ['NEW', 'ASSIGNED', 'IN_PROGRESS', 'ON_HOLD'] }
  }
});

if (activeJobs > 0) {
  return { error: `Cannot delete customer with ${activeJobs} active job(s)`, status: 400 };
}
```

**Deletion Options:**
1. **Soft Delete (Recommended)**:
   - Update `status` to `INACTIVE`
   - Customer record preserved
   - Can be reactivated later
   - Job relationships intact

2. **Hard Delete**:
   - Only if no jobs exist OR all jobs are COMPLETED/CANCELLED
   - Permanently removes customer record
   - Requires explicit confirmation

### API Specifications
**[Source: Established patterns from Story 2.1, 2.2, 2.3]**

**New Endpoints:**

1. **DELETE /api/customers/[id]** (Hard Delete)
   - Authorization: Admin role required
   - Pre-checks: No active jobs exist
   - Response Success: { message: "Customer deleted successfully" }
   - Response Error: { error: "Cannot delete customer with active jobs", activeJobCount: number }
   - Status Codes: 200 (success), 400 (has active jobs), 403 (not admin), 404 (not found)

2. **PATCH /api/customers/[id]/deactivate** (Soft Delete)
   - Authorization: Admin role required
   - Action: Set status = 'INACTIVE'
   - Response: Updated customer object with status INACTIVE
   - Status Codes: 200 (success), 403 (not admin), 404 (not found)

### Authorization Rules
**[Source: PRD section 2.1 - User Roles & Permissions]**
- **Admin**: Full delete capabilities (soft and hard delete)
- **Operations/Manager**: Cannot delete customers (read-only)
- Implementation: Check `session?.user?.role === 'ADMIN'` before allowing deletion

### File Locations for New Code
**[Source: docs/architecture/source-tree.md, existing patterns]**

**Backend:**
- **Modify API Route**: `apps/crm-app/app/api/customers/[id]/route.ts` (add DELETE handler)
- **New Deactivate Endpoint**: `apps/crm-app/app/api/customers/[id]/deactivate/route.ts` (CREATE)
- **Customer Service**: `apps/crm-app/lib/services/customer.ts` (add deleteCustomer, deactivateCustomer methods)

**Frontend:**
- **Delete Dialog Component**: `apps/crm-app/components/shared/DeleteCustomerDialog.tsx` (CREATE)
- **Customer List**: `apps/crm-app/components/shared/EnhancedCustomerTable.tsx` (MODIFY - add delete button)
- **Customer Detail Page**: `apps/crm-app/app/(dashboard)/customers/[id]/page.tsx` (MODIFY - add delete button)

**Testing:**
- **API Tests**: `apps/crm-app/__tests__/api/customers/[id]/route.test.ts` (MODIFY - add DELETE tests)
- **Service Tests**: `apps/crm-app/__tests__/services/customer.test.ts` (MODIFY)
- **Component Tests**: `apps/crm-app/__tests__/components/shared/DeleteCustomerDialog.test.tsx` (CREATE)
- **E2E Tests**: `apps/crm-app/tests/e2e/customer-deletion.spec.ts` (CREATE)

### UI/UX Patterns

**[Enhanced by Luna (UX/UI Designer) - 2025-09-30]**

### Design Philosophy
- **Safety First**: Use progressive disclosure to prevent accidental deletions
- **Clear Consequences**: Show exactly what will be deleted and why
- **Guided Alternatives**: Suggest deactivation when deletion is not possible
- **Consistent Feedback**: Provide clear success/error messages

### Delete Button Placement

#### Customer List - Actions Column
Located in the rightmost actions dropdown menu:

```tsx
<DropdownMenu>
  <DropdownMenuTrigger>
    <MoreHorizontal className="h-4 w-4" />
  </DropdownMenuTrigger>
  <DropdownMenuContent align="end">
    <DropdownMenuItem onClick={handleView}>
      <Eye className="w-4 h-4 mr-2" />
      View Details
    </DropdownMenuItem>
    <DropdownMenuItem onClick={handleEdit}>
      <Pencil className="w-4 h-4 mr-2" />
      Edit Customer
    </DropdownMenuItem>
    <DropdownMenuSeparator />

    {/* Show delete only for customers without active jobs */}
    {activeJobCount === 0 ? (
      <DropdownMenuItem
        onClick={handleDelete}
        className="text-destructive focus:text-destructive"
      >
        <Trash2 className="w-4 h-4 mr-2" />
        Delete Customer
      </DropdownMenuItem>
    ) : (
      <DropdownMenuItem disabled>
        <AlertCircle className="w-4 h-4 mr-2 text-muted" />
        Cannot Delete ({activeJobCount} active jobs)
      </DropdownMenuItem>
    )}

    <DropdownMenuItem onClick={handleDeactivate}>
      <Ban className="w-4 h-4 mr-2" />
      Deactivate Instead
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

#### Customer Detail Page - Header
Located in page header as secondary action:

```tsx
<div className="flex items-center justify-between">
  <div className="flex items-center gap-4">
    <Button variant="ghost" onClick={goBack}>
      <ArrowLeft className="w-4 h-4 mr-2" />
      Back
    </Button>
    <div>
      <h1 className="text-2xl font-bold">{customer.name}</h1>
      <CustomerStatusBadge status={customer.status} />
    </div>
  </div>

  <div className="flex gap-2">
    <Button variant="outline" onClick={handleEdit}>
      <Pencil className="w-4 h-4 mr-2" />
      Edit
    </Button>

    {/* Show deactivate button based on status */}
    {customer.status === 'ACTIVE' ? (
      <Button variant="outline" onClick={handleDeactivate}>
        <Ban className="w-4 h-4 mr-2" />
        Deactivate
      </Button>
    ) : (
      <Button variant="outline" onClick={handleReactivate}>
        <RotateCcw className="w-4 h-4 mr-2" />
        Reactivate
      </Button>
    )}
  </div>
</div>
```

### Two-Step Confirmation Flow

#### Step 1: Initial Warning Dialog with Job Impact

Use shadcn/ui `AlertDialog` component with custom styling:

```tsx
<AlertDialog>
  <AlertDialogContent className="max-w-md">
    <AlertDialogHeader>
      <AlertDialogTitle className="flex items-center gap-2">
        <AlertCircle className="w-5 h-5 text-yellow-600" />
        Delete Customer?
      </AlertDialogTitle>
      <AlertDialogDescription className="space-y-4">
        {/* Customer Info */}
        <div className="bg-muted p-4 rounded-md space-y-2">
          <div className="font-semibold">{customer.name}</div>
          <div className="text-sm text-muted-foreground">
            Phone: {customer.phone}
          </div>
          {customer.email && (
            <div className="text-sm text-muted-foreground">
              Email: {customer.email}
            </div>
          )}
        </div>

        {/* Job Count with Visual Indicators */}
        <div className="space-y-2">
          <div className="flex items-center justify-between text-sm">
            <span>Total Jobs:</span>
            <span className="font-semibold">{totalJobCount}</span>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span>Active Jobs:</span>
            <span className={cn(
              "font-semibold",
              activeJobCount > 0 ? "text-red-600" : "text-green-600"
            )}>
              {activeJobCount}
            </span>
          </div>
          <div className="flex items-center justify-between text-sm">
            <span>Completed Jobs:</span>
            <span className="font-semibold">{completedJobCount}</span>
          </div>
        </div>

        {/* Active Jobs Blocking Notice */}
        {activeJobCount > 0 && (
          <Alert variant="destructive">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>Cannot Delete</AlertTitle>
            <AlertDescription>
              This customer has {activeJobCount} active job(s) that must be
              completed or cancelled first.
            </AlertDescription>
          </Alert>
        )}

        {/* View Active Jobs Link */}
        {activeJobCount > 0 && (
          <Button
            variant="link"
            onClick={handleViewActiveJobs}
            className="w-full"
          >
            View Active Jobs
            <ArrowRight className="w-4 h-4 ml-2" />
          </Button>
        )}
      </AlertDialogDescription>
    </AlertDialogHeader>

    <AlertDialogFooter className="flex-col sm:flex-row gap-2">
      <AlertDialogCancel>Cancel</AlertDialogCancel>

      {/* Always show deactivate option */}
      <Button
        variant="outline"
        onClick={handleDeactivate}
        className="w-full sm:w-auto"
      >
        <Ban className="w-4 h-4 mr-2" />
        Deactivate Instead
      </Button>

      {/* Only show delete if no active jobs */}
      {activeJobCount === 0 && (
        <Button
          variant="destructive"
          onClick={handleProceedToDelete}
          className="w-full sm:w-auto"
        >
          Delete Permanently
          <ArrowRight className="w-4 h-4 ml-2" />
        </Button>
      )}
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

#### Step 2: Final Confirmation with Type-to-Confirm

For hard delete when no active jobs exist:

```tsx
<AlertDialog>
  <AlertDialogContent className="max-w-md">
    <AlertDialogHeader>
      <AlertDialogTitle className="flex items-center gap-2 text-destructive">
        <XCircle className="w-5 h-5" />
        Permanent Deletion Confirmation
      </AlertDialogTitle>
      <AlertDialogDescription className="space-y-4">
        {/* Warning */}
        <Alert variant="destructive">
          <AlertTriangle className="h-4 w-4" />
          <AlertTitle>This action CANNOT be undone</AlertTitle>
          <AlertDescription>
            Customer "{customer.name}" and all associated data will be
            permanently removed from the system.
          </AlertDescription>
        </Alert>

        {/* Alternative Suggestion */}
        <div className="bg-muted p-4 rounded-md">
          <div className="text-sm font-medium mb-2">
            💡 Alternative: Deactivate Instead
          </div>
          <div className="text-sm text-muted-foreground">
            You can deactivate this customer to hide them while preserving
            all data for future reference.
          </div>
          <Button
            variant="link"
            onClick={handleDeactivateInstead}
            className="px-0 mt-2"
          >
            Deactivate Customer Instead
          </Button>
        </div>

        {/* Type to Confirm */}
        <div className="space-y-2">
          <Label htmlFor="confirm-input" className="text-sm">
            Type <span className="font-mono font-bold">DELETE</span> to confirm:
          </Label>
          <Input
            id="confirm-input"
            value={confirmText}
            onChange={(e) => setConfirmText(e.target.value)}
            placeholder="DELETE"
            className="font-mono"
            autoComplete="off"
          />
        </div>
      </AlertDialogDescription>
    </AlertDialogHeader>

    <AlertDialogFooter>
      <AlertDialogCancel onClick={handleGoBack}>Go Back</AlertDialogCancel>
      <Button
        variant="destructive"
        onClick={handleConfirmDelete}
        disabled={confirmText !== 'DELETE' || isDeleting}
      >
        {isDeleting ? (
          <>
            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            Deleting...
          </>
        ) : (
          <>
            <Trash2 className="w-4 h-4 mr-2" />
            Confirm Permanent Delete
          </>
        )}
      </Button>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### Active Jobs Blocking Dialog

When users try to delete but active jobs exist, show detailed job list:

```tsx
<Dialog>
  <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle className="flex items-center gap-2">
        <AlertCircle className="w-5 h-5 text-yellow-600" />
        Cannot Delete Customer - Active Jobs Exist
      </DialogTitle>
      <DialogDescription>
        This customer has {activeJobCount} active job(s) that must be
        completed or cancelled before deletion.
      </DialogDescription>
    </DialogHeader>

    <div className="space-y-4 py-4">
      {activeJobs.map((job) => (
        <Card key={job.id}>
          <CardContent className="p-4">
            <div className="flex items-start justify-between">
              <div className="space-y-2 flex-1">
                <div className="flex items-center gap-2">
                  <Badge variant="outline">#{job.id.slice(0, 8)}</Badge>
                  <JobStatusBadge status={job.status} />
                </div>
                <div className="font-medium">{job.serviceType}</div>
                <div className="text-sm text-muted-foreground space-y-1">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4" />
                    {formatDate(job.scheduledDate)}
                  </div>
                  {job.assignedUser && (
                    <div className="flex items-center gap-2">
                      <User className="w-4 h-4" />
                      Assigned to: {job.assignedUser.name}
                    </div>
                  )}
                </div>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => handleViewJob(job.id)}
              >
                View Job
                <ArrowRight className="w-4 h-4 ml-2" />
              </Button>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>

    <DialogFooter className="flex-col sm:flex-row gap-2">
      <Button variant="outline" onClick={handleClose} className="w-full sm:w-auto">
        Close
      </Button>
      <Button
        onClick={handleDeactivateCustomer}
        className="w-full sm:w-auto"
      >
        <Ban className="w-4 h-4 mr-2" />
        Deactivate Customer Instead
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

### Customer Status Badge Component

Visual indicator for customer status:

```tsx
const CustomerStatusBadge = ({ status }: { status: CustomerStatus }) => {
  const statusConfig = {
    ACTIVE: {
      label: 'Active',
      icon: CheckCircle2,
      className: 'bg-green-100 text-green-800 border-green-300'
    },
    INACTIVE: {
      label: 'Inactive',
      icon: Ban,
      className: 'bg-orange-100 text-orange-800 border-orange-300'
    },
    BLOCKED: {
      label: 'Blocked',
      icon: XCircle,
      className: 'bg-red-100 text-red-800 border-red-300'
    }
  };

  const config = statusConfig[status];
  const Icon = config.icon;

  return (
    <Badge variant="outline" className={cn('gap-1', config.className)}>
      <Icon className="w-3 h-3" />
      {config.label}
    </Badge>
  );
};
```

### Inactive Customer Management

#### Filter Toggle in Customer List

```tsx
<div className="flex items-center justify-between mb-4">
  <div className="flex items-center gap-4">
    {/* Search */}
    <div className="relative w-64">
      <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground" />
      <Input
        placeholder="Search customers..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        className="pl-10"
      />
    </div>

    {/* Status Filter */}
    <Select value={statusFilter} onValueChange={setStatusFilter}>
      <SelectTrigger className="w-[180px]">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="ACTIVE">Active Only</SelectItem>
        <SelectItem value="INACTIVE">Inactive Only</SelectItem>
        <SelectItem value="ALL">All Customers</SelectItem>
        <SelectItem value="BLOCKED">Blocked Only</SelectItem>
      </SelectContent>
    </Select>
  </div>

  {/* Add Customer Button */}
  {session?.user?.role === 'ADMIN' && (
    <Button onClick={handleAddCustomer}>
      <Plus className="w-4 h-4 mr-2" />
      Add Customer
    </Button>
  )}
</div>
```

### Success and Error Feedback

#### Success Toast with Undo Option (Soft Delete)

```tsx
// For deactivation (soft delete)
toast({
  title: "Customer Deactivated",
  description: `${customer.name} has been deactivated successfully.`,
  action: (
    <ToastAction
      altText="Undo deactivation"
      onClick={handleUndo}
    >
      Undo
    </ToastAction>
  ),
});
```

#### Success Toast (Hard Delete)

```tsx
// For permanent deletion
toast({
  title: "Customer Deleted",
  description: `${customer.name} has been permanently deleted.`,
  variant: "default",
});
```

#### Error Toast

```tsx
// For failed deletion
toast({
  title: "Cannot Delete Customer",
  description: `This customer has ${activeJobCount} active jobs. Complete or cancel them first.`,
  variant: "destructive",
  action: (
    <ToastAction
      altText="View active jobs"
      onClick={handleViewJobs}
    >
      View Jobs
    </ToastAction>
  ),
});
```

### Mobile Responsive Design

#### Breakpoint Specifications

```tsx
// Mobile (<640px): Stack buttons vertically
// Tablet (640px-1024px): Horizontal layout with wrapping
// Desktop (>1024px): Full horizontal layout

<div className="flex flex-col sm:flex-row gap-2 sm:gap-4">
  {/* Buttons automatically stack on mobile, horizontal on desktop */}
</div>
```

#### Touch Target Sizes

```tsx
// All interactive elements meet 44px minimum
<Button
  className="min-h-[44px] min-w-[44px]"
  // ...props
>
  {/* Content */}
</Button>
```

### Accessibility Features

#### Keyboard Navigation

```tsx
// Dialog trap focus
<AlertDialog>
  <AlertDialogContent
    onOpenAutoFocus={(e) => {
      // Focus on cancel button by default (safe action)
      e.preventDefault();
      const cancelButton = e.currentTarget.querySelector('[data-cancel]');
      cancelButton?.focus();
    }}
  >
    {/* Content */}
  </AlertDialogContent>
</AlertDialog>
```

#### Screen Reader Announcements

```tsx
// Announce deletion result
const announceToScreenReader = (message: string) => {
  const announcement = document.createElement('div');
  announcement.setAttribute('role', 'status');
  announcement.setAttribute('aria-live', 'polite');
  announcement.className = 'sr-only';
  announcement.textContent = message;
  document.body.appendChild(announcement);
  setTimeout(() => announcement.remove(), 1000);
};

// Usage
announceToScreenReader(`Customer ${customer.name} has been deleted successfully`);
```

#### ARIA Labels

```tsx
<Button
  variant="ghost"
  size="icon"
  onClick={handleDelete}
  aria-label={`Delete customer ${customer.name}`}
>
  <Trash2 className="w-4 h-4" />
</Button>
```

### Visual Hierarchy and Color System

#### Button Hierarchy in Dialogs

```tsx
// Left to Right priority (Western reading)
// 1. Cancel (ghost/outline) - lowest priority
// 2. Alternative action (outline) - medium priority
// 3. Primary action (destructive for delete) - highest priority

<AlertDialogFooter>
  <AlertDialogCancel>Cancel</AlertDialogCancel>
  <Button variant="outline">Alternative</Button>
  <Button variant="destructive">Delete</Button>
</AlertDialogFooter>
```

#### Color Coding

```tsx
// Status colors
const colors = {
  safe: 'text-green-600',      // Safe actions (deactivate)
  warning: 'text-yellow-600',  // Warnings
  danger: 'text-red-600',      // Destructive actions
  info: 'text-blue-600',       // Informational
  muted: 'text-muted-foreground' // Secondary info
};
```

### Component File Structure

```
apps/crm-app/components/shared/
├── DeleteCustomerDialog.tsx       (Main component)
├── CustomerStatusBadge.tsx        (Status indicator)
├── ActiveJobsList.tsx             (Jobs blocking deletion)
└── DeactivateCustomerDialog.tsx   (Soft delete component)
```

### Implementation Checklist

- [ ] Install required shadcn/ui components: `AlertDialog`, `Dialog`, `Alert`, `Toast`, `Badge`
- [ ] Create `DeleteCustomerDialog` component with two-step flow
- [ ] Create `CustomerStatusBadge` component
- [ ] Add delete button to customer list actions dropdown
- [ ] Add deactivate button to customer detail page
- [ ] Implement soft delete API endpoint `/api/customers/[id]/deactivate`
- [ ] Add status filter to customer list page
- [ ] Implement keyboard navigation for dialogs
- [ ] Add ARIA labels for accessibility
- [ ] Test with screen readers (NVDA/JAWS)
- [ ] Verify touch targets are 44px minimum on mobile
- [ ] Test confirmation flow on all screen sizes
- [ ] Implement success/error toast notifications
- [ ] Add undo functionality for soft delete

**Design QA Checklist:**
- [ ] Color contrast meets WCAG 2.1 AA (4.5:1 minimum)
- [ ] Focus indicators visible on all interactive elements
- [ ] Error messages are clear and actionable
- [ ] Success feedback is immediate and visible
- [ ] Mobile layout tested on 375px viewport
- [ ] Keyboard navigation works without mouse
- [ ] Screen reader announces all important actions
- [ ] Button labels are descriptive and clear

### Technical Constraints
**[Source: docs/architecture/tech-stack.md, CLAUDE.md]**
- TypeScript mandatory for all code
- Use Prisma ORM for database operations
- Follow Repository Pattern through service layer
- Use NextAuth.js v5 for authentication
- Use shadcn/ui components (AlertDialog, Button, Toast)
- Maintain consistency with existing API response formats
- Ensure mobile-responsive design with Tailwind CSS
- Implement proper error handling and user feedback

### Integration Points
**[Source: Story 2.1, 2.2, 2.3 implementations]**
- **Existing Customer Service**: Extend with delete methods
- **Existing Customer API**: Add DELETE handler to existing route
- **Existing Customer List**: Integrate delete button in actions column
- **Existing Auth Middleware**: Use established Admin-only patterns
- **Existing Toast System**: Use for success/error notifications

### Testing

**[Source: docs/architecture/tech-stack.md, established testing patterns]**

**Test File Locations:**
- Backend API Tests: `apps/crm-app/__tests__/api/customers/[id]/route.test.ts`
- Service Tests: `apps/crm-app/__tests__/services/customer.test.ts`
- Component Tests: `apps/crm-app/__tests__/components/shared/DeleteCustomerDialog.test.tsx`
- E2E Tests: `apps/crm-app/tests/e2e/customer-deletion.spec.ts`

**Testing Frameworks:**
- Backend: Vitest for API and service testing
- Frontend: Jest + React Testing Library for components
- E2E: Playwright for full user workflows

**Test Scenarios:**

1. **Authorization Tests** (5 tests):
   - Admin can access delete endpoints
   - Operations user cannot delete (403)
   - Unauthenticated user cannot delete (401)
   - Only Admin sees delete buttons in UI
   - Delete button hidden for non-Admin roles

2. **Safety Validation Tests** (8 tests):
   - Cannot delete customer with NEW jobs
   - Cannot delete customer with ASSIGNED jobs
   - Cannot delete customer with IN_PROGRESS jobs
   - Cannot delete customer with ON_HOLD jobs
   - Can delete customer with only COMPLETED jobs
   - Can delete customer with only CANCELLED jobs
   - Can delete customer with no jobs
   - Can soft delete customer with active jobs

3. **Soft Delete Tests** (4 tests):
   - Deactivate changes status to INACTIVE
   - Inactive customers filtered from default list
   - "Show Inactive" toggle displays inactive customers
   - Can reactivate inactive customers

4. **UI Component Tests** (6 tests):
   - DeleteCustomerDialog renders with customer info
   - Shows correct job count in warning
   - Displays appropriate buttons based on active job count
   - Cancel button closes dialog without action
   - Deactivate button calls soft delete API
   - Delete button calls hard delete API (if allowed)

5. **E2E Tests** (4 tests):
   - Complete flow: Delete customer with no jobs
   - Complete flow: Attempt delete with active jobs (blocked)
   - Complete flow: Soft delete customer with active jobs
   - Complete flow: Delete from detail page vs list page

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for customer deletion with safety checks | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent during implementation)

### Debug Log References
(To be filled by Dev Agent during implementation)

### Completion Notes List
(To be filled by Dev Agent during implementation)

### File List
(To be filled by Dev Agent during implementation)

## QA Results

(To be filled by QA Agent after implementation review)