# Story 4.3: Basic In-App Notification System

<!-- Powered by BMAD™ Core -->

## Status
Draft (Optional - Nice to Have)

## Story
**As an** Operations Team Member,
**I want** to receive in-app notifications when I'm assigned a new job or when job status changes,
**so that** I can respond quickly without constantly checking the dashboard manually.

## Acceptance Criteria

1. Notification bell icon displayed in header with unread count badge
2. Click bell opens notification panel (dropdown/popover) showing recent notifications
3. Each notification shows: icon, title, message, timestamp, read/unread indicator
4. Notification types supported:
   - New job assignment: "You have been assigned to Job #12345"
   - Job status changed to IN_PROGRESS: "Job #12345 started by [User Name]"
   - Job completed: "Job #12345 has been completed"
   - Checklist completed: "Checklist for Job #12345 is 100% complete"
5. Click notification navigates to related job detail page
6. Mark individual notification as read/unread
7. "Mark all as read" button in notification panel
8. Clear all notifications button (soft delete, can restore)
9. Notifications persist across page reloads and browser sessions
10. Real-time updates using polling (check every 30 seconds) or SSE (optional)

## Tasks / Subtasks

- [ ] Create Notification data model (AC: 9)
  - [ ] Add Notification model to Prisma schema
  - [ ] Fields: id, userId, type, title, message, jobId, isRead, createdAt
  - [ ] Create migration

- [ ] Build Notification API endpoints (AC: 2, 6, 7, 8)
  - [ ] GET /api/notifications - list user's notifications
  - [ ] PATCH /api/notifications/[id]/read - mark as read
  - [ ] POST /api/notifications/mark-all-read - mark all as read
  - [ ] DELETE /api/notifications/[id] - soft delete notification

- [ ] Create notification bell component (AC: 1)
  - [ ] Add bell icon to header (lucide-react Bell icon)
  - [ ] Show unread count badge
  - [ ] Use shadcn/ui Popover for notification panel

- [ ] Build notification panel UI (AC: 2, 3)
  - [ ] Display list of notifications with icons
  - [ ] Color code unread (bold) vs read (gray)
  - [ ] Show relative timestamps ("2 minutes ago")
  - [ ] Empty state when no notifications

- [ ] Implement notification actions (AC: 5, 6, 7, 8)
  - [ ] Click notification → navigate to job detail page
  - [ ] Mark as read/unread toggle
  - [ ] Mark all as read button
  - [ ] Clear all button

- [ ] Add notification triggers (AC: 4)
  - [ ] Create notification on job assignment (in JobService)
  - [ ] Create notification on status change to IN_PROGRESS
  - [ ] Create notification on job completion
  - [ ] Create notification on checklist 100% complete

- [ ] Implement real-time updates (AC: 10)
  - [ ] Polling: useInterval to fetch new notifications every 30s
  - [ ] OR Server-Sent Events (SSE) for real-time push (advanced)
  - [ ] Update bell badge count on new notifications

- [ ] Add comprehensive testing
  - [ ] API tests for notification endpoints
  - [ ] Component tests for bell and panel
  - [ ] Test notification creation triggers
  - [ ] E2E test for notification workflow

## Dev Notes

**Quick Reference:**
- Notification model links to User and Job
- Bell icon uses shadcn/ui Popover component
- Polling interval: 30 seconds (configurable)
- Nice-to-have feature - can be skipped if time constrained

**Prisma Model:**
```prisma
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // "JOB_ASSIGNED", "STATUS_CHANGED", "CHECKLIST_COMPLETE"
  title     String
  message   String
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id])
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-30 | 1.0 | Initial story creation for notification system | Sarah (Product Owner) |

## Dev Agent Record

(To be filled by Dev Agent during implementation)

## QA Results

(To be filled by QA Agent after implementation review)